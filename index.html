<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      sdorsett.github.io &middot; Things I find interesting
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/posts/">All Posts</a>
        
      
    
      
        
      
    
    <a class="sidebar-nav-item" href="https://github.com/sdorsett/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="https://github.com/sdorsett">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2014. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">sdorsett.github.io</a>
            <small>Things I find interesting</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/05/26/vagrant-install/">
        Installing Vagrant and the vagrant-vcloud plugin on CentOS 6.x
      </a>
    </h1>

    <span class="post-date">26 May 2014</span>

    <p>In this post I&#39;m setting out to explain how to create a CentOS 6.4 vm, from template, in vCHS (or a vCloud Director instance) and then install vagrant-vcloud on that. </p>

<h3>1. Create a CentOS 6.x minimal virtual machine from a template in a vCHS organization.</h3>

<p>I will demonstrate creating a new CentOS vm in vCHS using a template, but you could just as easily create a new CentOS virtual machine from scratch in vCloud Director.</p>

<h4>A. Log into vCHS using your credentials and click on your virtual datacenter.</h4>

<h4>B. Next click on the &quot;Virtual Machines&quot; tab and then click the &quot;Deploy a Virtual Machine&quot; button:</h4>

<p><img src="/assets/01-create-centos-64-vm.png" alt="screenshot"></p>

<h4>C. Select the &quot;CentOS 6.4 64 Bit&quot; template and click &quot;Continue&quot;</h4>

<p><img src="/assets/02-select-centos-64-template.png" alt="screenshot"></p>

<h4>D. Name the virtual machine and set the guest OS name of your new virtual machine. Click &quot;Deploy This Virtual Machine&quot;:</h4>

<p>I named my virtual machine and set the guest OS name both to &quot;vagrant&quot;, but you can change these to what ever you prefer.</p>

<p><img src="/assets/03-virtual-machine-resource-settings.png" alt="screenshot"></p>

<h4>E. Power on and then click the name of the virtual machine you just created:</h4>

<p><img src="/assets/04-centos-vm-created.png" alt="screenshot"></p>

<h4>F. Click the &quot;Launch Console&quot; link to open the console of the virtual machine you just created.</h4>

<p>Notice that the guest OS password created by guest customization is displayed on the left. Log into the virtual machine, using &quot;root&quot; and the displayed password, then change this password immediately to something else:</p>

<p><img src="/assets/05-open-console-and-log-in.png" alt="screenshot"></p>

<h3>2. Modify /etc/resolv.conf</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># cat /etc/resolv.conf</span>
nameserver 8.8.8.8 
nameserver 8.8.4.4
</code></pre></div>

<h3>3. Install Ruby 1.9.3 using ruby-build:</h3>

<h4>A. Use yum to install the packages we&#39;ll need to get ruby, rubygems and vagrant installed:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># yum install -y gcc-c++ glibc-headers openssl-devel readline libyaml-devel readline-devel zlib zlib-devel iconv-devel libxml2 libxml2-devel libxslt libxslt-devel wget git</span>
</code></pre></div>

<h4>B. Pull down the latest version of ruby-build using git:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># git clone https://github.com/sstephenson/ruby-build.git</span>
</code></pre></div>

<h4>C. Change to the directory the previous command created:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># cd ruby-build/</span>
</code></pre></div>

<h4>D. Run the &#39;install.sh&#39; script to install ruby-build:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ruby-build<span class="o">]</span><span class="c"># ./install.sh</span>
</code></pre></div>

<h4>E. I would recommend installing Ruby version 1.9.3-p545 with the following command:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ruby-build<span class="o">]</span><span class="c"># ruby-build --definitionsruby-build 1.9.3-p545 /usr/local/</span>
Downloading yaml-0.1.6.tar.gz...
-&gt; http://dqw8nmjcqpjn7.cloudfront.net/5fe00cda18ca5daeb43762b80c38e06e
Installing yaml-0.1.6...
Installed yaml-0.1.6 to /usr/local/

Downloading ruby-1.9.3-p545.tar.gz...
-&gt; http://dqw8nmjcqpjn7.cloudfront.net/8e8f6e4d7d0bb54e0edf8d9c4120f40c
Installing ruby-1.9.3-p545...

Installed ruby-1.9.3-p545 to /usr/local/
</code></pre></div>

<h3>4. Install rubygems by downloading the latest version from <a href="https://rubygems.org/pages/download">rubygems.org</a> and install it:</h3>

<h4>A. Use wget to download the latest version listed on the rubygems download page:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ruby-build<span class="o">]</span><span class="c"># cd ~/</span>
<span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># wget http://production.cf.rubygems.org/rubygems/rubygems-2.2.2.tgz</span>
</code></pre></div>

<h4>B. Use tar to unzip the tar-gzipped file we downloaded:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># tar xvzf rubygems-2.2.2.tgz</span>
<span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># cd rubygems-2.2.2</span>
</code></pre></div>

<h4>C. Install rubygems by running the &#39;setup.rb&#39; script:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant rubygems-2.2.2<span class="o">]</span><span class="c"># ruby setup.rb</span>
</code></pre></div>

<h3>5. Install Vagrant</h3>

<h4>A. Use wget to download the latest version listed on the <a href="https://www.vagrantup.com/downloads.html">Vagrant download</a> page:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant rubygems-2.2.2<span class="o">]</span><span class="c"># cd ~/</span>
<span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># wget https://dl.bintray.com/mitchellh/vagrant/vagrant_1.6.2_x86_64.rpm</span>
</code></pre></div>

<h4>B. Use the &#39;rpm&#39; command to install the RPM package we downloaded in the previous step:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># rpm -i vagrant_1.6.2_x86_64.rpm</span>
</code></pre></div>

<h4>C. Export the directory that the vagrant executable was install to, in order to make it easier to run:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># export PATH=$PATH:/opt/vagrant/bin/</span>
</code></pre></div>

<h3>6. Installing the vagrant-vcloud plugin</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant blog<span class="o">]</span><span class="c"># vagrant plugin install vagrant-vcloud</span>
Installing the <span class="s1">&#39;vagrant-vcloud&#39;</span> plugin. This can take a few minutes...
Installed the plugin <span class="s1">&#39;vagrant-vcloud (0.3.3)&#39;</span>!
</code></pre></div>

<h3>7. Creating a Vagrantfile for testing vagrant-vcloud install</h3>

<h4>A.  We need to create a directory structure and Vagrantfile to test that the vagrant-vcloud provider is properly working. For the .box file we will use a sample precise32 (Ubuntu 12.04 32bit) vagrant .box file created for the vcloud provider by Timo Sugliani:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># mkdir -p ~/vagrant-vms/precise32-test</span>
<span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># cat ~/vagrant-vms/precise32-test/Vagrantfile </span>
<span class="nv">precise32_vm_box_url</span> <span class="o">=</span> <span class="s2">&quot;http://vagrant.tsugliani.fr/precise32.box&quot;</span>

<span class="nv">nodes</span> <span class="o">=</span> <span class="o">[</span>
  <span class="o">{</span> :hostname <span class="o">=</span>&gt; <span class="s2">&quot;test-vm&quot;</span>,  
    :box <span class="o">=</span>&gt; <span class="s2">&quot;precise32&quot;</span>, 
    :box_url <span class="o">=</span>&gt; precise32_vm_box_url <span class="o">}</span>
<span class="o">]</span>

Vagrant.configure<span class="o">(</span><span class="s2">&quot;2&quot;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>

  <span class="c"># vCloud Director provider settings</span>
  config.vm.provider :vcloud <span class="k">do</span> <span class="p">|</span>vcloud<span class="p">|</span>

    vcloud.hostname <span class="o">=</span> <span class="s1">&#39;[Youor_vCHS_vCloud_Director_API_URL]&#39;</span>
    vcloud.username <span class="o">=</span> <span class="s1">&#39;[Your_vCHS_username@somedomain.com]&#39;</span>
    vcloud.password <span class="o">=</span> <span class="s1">&#39;[Your_vCHS_password]&#39;</span>

    vcloud.org_name <span class="o">=</span> <span class="s1">&#39;[Your_vCHS_org_name]&#39;</span>
    vcloud.vdc_name <span class="o">=</span> <span class="s1">&#39;[Your_vCHS_vdc_name]&#39;</span>
    vcloud.catalog_name <span class="o">=</span> <span class="s1">&#39;[Your_vCHS_org_catalog]&#39;</span>
    vcloud.network_bridge <span class="o">=</span> <span class="nb">true</span>
<span class="nb">    </span>vcloud.vdc_network_name <span class="o">=</span> <span class="s1">&#39;[Your_vCHS_vdc_network_name]&#39;</span>

  end

  nodes.each <span class="k">do</span> <span class="p">|</span>node<span class="p">|</span>
    config.vm.define node<span class="o">[</span>:hostname<span class="o">]</span> <span class="k">do</span> <span class="p">|</span>node_config<span class="p">|</span>
      node_config.vm.box <span class="o">=</span> node<span class="o">[</span>:box<span class="o">]</span>
      node_config.vm.hostname <span class="o">=</span> node<span class="o">[</span>:hostname<span class="o">]</span>
      node_config.vm.box_url <span class="o">=</span> node<span class="o">[</span>:box_url<span class="o">]</span>
    end
  end
end
</code></pre></div>

<h4>B.  Now we can change directory to that directory and test everything with a &quot;vagrant up --provider=vcloud&quot;:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># cd /root/.vagrant.d/gems/gems/vagrant-vsphere-0.8.1/example_box</span>
<span class="o">[</span>root@vagrant example_box<span class="o">]</span><span class="c"># tar cvzf dummy.box ./metadata.json</span>
./metadata.json
</code></pre></div>

<h4>C.  Next we will create a new folder under /root for storing the box file we created and other vagrant configuration files</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant example_box<span class="o">]</span><span class="c"># mkdir -p ~/vagrant-vms/example_box</span>
<span class="o">[</span>root@vagrant example_box<span class="o">]</span><span class="c"># mv dummy.box ~/vagrant-vms/example_box</span>
</code></pre></div>

<h4>D. Vagrant reads it&#39;s configuration from a file named Vagrantfile, located in the directory from which the &quot;vagrant up&quot; command is run in. We need to go back to our &quot;vagrant-vms&quot; folder and create this file:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant example_box<span class="o">]</span><span class="c"># cd ~/vagrant-vms/</span>
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># touch Vagrantfile</span>
</code></pre></div>

<h4>E. Modify the Vagrantfile to reflect your vsphere configuration. Here&#39;s an example of my working Vagrantfile:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># cat Vagrantfile</span>

Vagrant.configure<span class="o">(</span><span class="s2">&quot;2&quot;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
  config.vm.box <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
  config.vm.box_url <span class="o">=</span> <span class="s1">&#39;./example_box/dummy.box&#39;</span>

  config.vm.provider :vsphere <span class="k">do</span> <span class="p">|</span>vsphere<span class="p">|</span>
    vsphere.host <span class="o">=</span> <span class="s1">&#39;vcenter.mylab.net&#39;</span>
    vsphere.name <span class="o">=</span> <span class="s1">&#39;vagrant-test&#39;</span>
    vsphere.clone_from_vm <span class="o">=</span> <span class="nb">true</span>
<span class="nb">    </span>vsphere.template_name <span class="o">=</span> <span class="s1">&#39;Centos-6.5&#39;</span>
    vsphere.user <span class="o">=</span> <span class="s1">&#39;root@localos&#39;</span>
    vsphere.password <span class="o">=</span> <span class="s1">&#39;S0meR@nd0mP@ssw0rd&#39;</span>
    vsphere.insecure <span class="o">=</span> <span class="nb">true</span>
<span class="nb">  </span>end
end
</code></pre></div>

<p>In this configuration file:</p>

<ul>
<li>&quot;vsphere.host&quot; is your vCenter server FQDN or IP address</li>
<li>&quot;vsphere.name&quot; will be the name of the virtual machine that gets created</li>
<li>&quot;vsphere.clone_from_vm&quot; specifies we will be cloning a vm rather than template</li>
<li>&quot;vsphere.template_name&quot; is the name of the vm we will be cloning</li>
<li>&quot;vsphere.user&quot; is the username we will be using to connect to vCenter</li>
<li>&quot;vsphere.password&quot; is the password we will be using to connect ot vCenter</li>
<li>&quot;vsphere.insecure&quot; tells vagrant to not worry about validating the certificate on the vCenter server</li>
</ul>

<h3>9. Vargrant up!!!!</h3>

<p>If everything has gone correctly up to this point we can issue a &quot;vagrant up --provider=vsphere&quot; command from the directory that contains the Vagrantfile:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant up --provider=vsphere</span>
Bringing machine <span class="s1">&#39;default&#39;</span> up with <span class="s1">&#39;vsphere&#39;</span> provider...
<span class="o">==</span>&gt; default: Calling vSphere CloneVM with the following settings:
<span class="o">==</span>&gt; default:  -- Source VM: CentOS-6.5
<span class="o">==</span>&gt; default:  -- Name: vagrant-test
<span class="o">==</span>&gt; default: Waiting <span class="k">for </span>SSH to become available...
</code></pre></div>

<p>You should see a &quot;Clone virtual machine&quot; task being run on your vCenter server and then completing.</p>

<h3>10. Canceling the &quot;Vagrant up&quot; command and destroying our cloned vm.</h3>

<p>Since we have not properly prepared the vm we are cloning (I will have another blog post covering this topic) Vagrant will never be able to successfully connect to the cloned vm using SSH. As a result we will need to cancel the &quot;vagrant up&quot; command:</p>

<h4>A. Press [control-c] to attempt to gracefully exit &quot;vagrant-up&quot;</h4>

<div class="highlight"><pre><code class="bash">^C<span class="o">==</span>&gt; default: Waiting <span class="k">for </span>cleanup before exiting...
</code></pre></div>

<p>I&#39;ve never seen this task complete so I will press [control-c] again to immediately exit:</p>

<div class="highlight"><pre><code class="bash">^C<span class="o">==</span>&gt; default: Exiting immediately, without cleanup!
</code></pre></div>

<h4>B. Destroy the cloned vm by running &quot;vagrant destroy&quot; command:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant destroy</span>
<span class="o">==</span>&gt; default: Calling vSphere <span class="nv">PowerOff</span>
<span class="o">==</span>&gt; default: Calling vShpere Destroy
</code></pre></div>

<p>You should see a &quot;Power Off virtual machine&quot; and &quot;Delet virtual machine&quot; tasks being run and then completing on your vCenter server.</p>

<h3>Hopefully you found this post helpful in getting vagrant and the vagrant-vsphere plugin installed and configured. The next blog post will be covering how to create a template vm that has been prepared for vagrant to connect seemlessly using SSH.</h3>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/05/25/vagrant-vcloud/">
        Introducing the vagrant-vcloud provider
      </a>
    </h1>

    <span class="post-date">25 May 2014</span>

    <p>While continuing to explore what the vagrant-vsphere provider is capable of I came across the <a href="https://github.com/frapposelli/vagrant-vcloud">vagrant-vcloud</a> provider, which had recently released a new version. I work for the vCHS operations group, so I figured it would be interesting to compare the feature differences of the vsphere &amp; vcloud providers. </p>

<p>Over the next few blog posts I intend to cover the following vagrant-vcloud provider related topics:</p>

<ul>
<li><a href="https://sdorsett.github.io/2014/04/19/vagrant-install/">Installing Vagant and the vagrant-vcloud plugin on a CentOS 6.x virtual machine in vCloud Directory or vCHS</a></li>
<li>Creating a simple vagrant-vcloud Vagrantfile configuration to deploy a vm </li>
<li>Creating a more advanced vagrant-vcloud Vagrantfile configuration</li>
<li>Creating a CentOS 6.x .box that is customized for Vagrant and vcloud director</li>
</ul>

<p>These posts will hopefully explain the steps necessary to get vagrant-vcloud installed and working with a vCloud Director or vCHS environment.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/05/06/vagrant-and-puppet/">
        Creating a Puppet manifest and integrating it with Vagrant
      </a>
    </h1>

    <span class="post-date">06 May 2014</span>

    <p>This post will cover configuring Vagrant to automatically run a Puppet manifest on the vm created by &quot;vagrant up.&quot; This capability allows you to test your Puppet manifests, make changes and test again, all quickly and easily. Let&#39;s get started:</p>

<h3>1. Create the Puppet manifest &amp; modules we will be using for our Vagrant tests.</h3>

<p>For testing purposes we will be creating a Puppet manifest that ensures NTP is installed and is configured to use the following NTP servers:</p>

<ul>
<li>0.pool.ntp.org</li>
<li>1.pool.ntp.org</li>
<li>2.pool.ntp.org</li>
</ul>

<h4>A. First we should install tree, since it will help us visualize the directory structure of the puppet manifest directories we will be creating:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># yum install -y tree</span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.centarra.com
 * epel: mirror.unl.edu
 * extras: mirrors.finalasp.com
 * updates: mirrors.centarra.com
Setting up Install Process
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package tree.x86_64 0:1.5.3-2.el6 will be installed
--&gt; Finished Dependency Resolution

Dependencies <span class="nv">Resolved</span>

<span class="o">====================================================================</span>
 Package      Arch           Version             Repository    <span class="nv">Size</span>
<span class="o">====================================================================</span>
Installing:
 tree         x86_64         1.5.3-2.el6         base          36 k

Transaction <span class="nv">Summary</span>
<span class="o">====================================================================</span>
Install       1 Package<span class="o">(</span>s<span class="o">)</span>

Total download size: 36 k
Installed size: 65 k
Downloading Packages:
tree-1.5.3-2.el6.x86_64.rpm                    <span class="p">|</span>  36 kB     00:00     
Running rpm_check_debug
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : tree-1.5.3-2.el6.x86_64                          1/1 
  Verifying  : tree-1.5.3-2.el6.x86_64                          1/1 

Installed:
  tree.x86_64 0:1.5.3-2.el6                                           

Complete!
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c">#</span>
</code></pre></div>

<h4>B. Change to the directory that contains the Vagrantfile &amp; example_box directory we&#39;ve been working in over the last few blog posts:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant ~<span class="o">]</span><span class="c"># cd ~/vagrant-vms/</span>
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># tree</span>
.
├── example_box
│   └── dummy.box
└── Vagrantfile

1 directory, 2 files
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c">#  </span>
</code></pre></div>

<h4>C. Create the following modules &amp; manifests directory structure for our Puppet manifest files:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># mkdir -p {manifests,modules/ntp/manifests,modules/ntp/templates,modules/common/manifests}</span>
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># tree</span>
.
├── example_box
│   └── dummy.box
├── manifests
├── modules
│   ├── common
│   │   └── manifests
│   └── ntp
│       ├── manifests
│       └── templates
└── Vagrantfile

8 directories, 2 files
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<h4>D. Create manifests/site.pp with the following contents:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vi manifests/site.pp</span>
node default <span class="o">{</span>
  include common
    class <span class="o">{</span><span class="s1">&#39;ntp&#39;</span>:<span class="o">}</span>
<span class="o">}</span>
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<p>This is the Puppet manifest that we will configure Vagrent to run automatically. The &quot;node default&quot; section will be applied by any hostname that runs this manifest. The &quot;node default&quot; section calls the common &amp; ntp modules which we will create next.</p>

<h4>E. Create modules/common/manifests/init.pp with the following contents:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># cat modules/common/manifests/init.pp</span>
class common <span class="o">{</span>
  include common::data
<span class="o">}</span>

class common::data <span class="o">{</span>
  <span class="nv">$ntpServerList</span> <span class="o">=</span> <span class="o">[</span> <span class="s1">&#39;0.pool.ntp.org&#39;</span>,<span class="s1">&#39;1.pool.ntp.org&#39;</span>,<span class="s1">&#39;2.pool.ntp.org&#39;</span> <span class="o">]</span>
<span class="o">}</span>
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<p>This manifest is what gets run when Puppets runs &quot;include common&quot; in the manifests/site.pp manifest. When this manifest is run it creates an array named &quot;common::data::ntpServerList&quot; containing the ntp servers we&#39;re needing to have defined.</p>

<h4>F. Create modules/ntp/manifests/init.pp with the following contents:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># cat modules/ntp/manifests/init.pp</span>
class ntp<span class="o">(</span> <span class="nv">$ntpServerList</span> <span class="o">=</span> <span class="nv">$common</span>::data::ntpServerList<span class="o">)</span> <span class="o">{</span>
  package <span class="o">{</span> <span class="s1">&#39;ntp&#39;</span>:
  <span class="nv">ensure</span> <span class="o">=</span>&gt; <span class="s1">&#39;present&#39;</span>,
  <span class="o">}</span> <span class="c">#package</span>

  file <span class="o">{</span> <span class="s1">&#39;/etc/ntp.conf&#39;</span>:
    <span class="nv">mode</span>    <span class="o">=</span>&gt; <span class="s2">&quot;644&quot;</span>,
    <span class="nv">content</span> <span class="o">=</span>&gt; template<span class="o">(</span><span class="s2">&quot;ntp/client-ntp.conf.erb&quot;</span><span class="o">)</span>,
    <span class="nv">notify</span>  <span class="o">=</span>&gt; Service<span class="o">[</span><span class="s2">&quot;ntpd&quot;</span><span class="o">]</span>,
    <span class="nv">require</span> <span class="o">=</span>&gt; Package<span class="o">[</span><span class="s2">&quot;ntp&quot;</span><span class="o">]</span>,
  <span class="o">}</span> <span class="c"># file</span>

  service <span class="o">{</span> <span class="s1">&#39;ntpd&#39;</span>:
    <span class="nv">ensure</span>  <span class="o">=</span>&gt; running,
    <span class="nb">enable</span>  <span class="o">=</span>&gt; <span class="nb">true</span>,
    <span class="nv">require</span> <span class="o">=</span>&gt; Package<span class="o">[</span><span class="s2">&quot;ntp&quot;</span><span class="o">]</span>,
  <span class="o">}</span> <span class="c"># service</span>
<span class="o">}</span>
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<p>This manifest is what gets run when Puppet calls &quot;class {&#39;ntp&#39;:}&quot; in the manifests/site.pp manifest. When this manifest is run it will ensure the ntp package is installed, the file &quot;/etc/ntp.conf&quot; is created containing our list of ntp servers and the ntpd service is started.    </p>

<h4>G. Create modules/ntp/templates/client-ntp.conf.erb with the following contents:</h4>

<div class="highlight"><pre><code class="bash"><span class="c"># This file is being maintained by Puppet.</span>
<span class="c"># DO NOT EDIT</span>

<span class="c"># Permit time synchronization with our time source, but do not</span>
<span class="c"># permit the source to query or modify the service on this system.</span>
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery

<span class="c"># Permit all access over the loopback interface.  This could</span>
<span class="c"># be tightened as well, but to do so would effect some of</span>
<span class="c"># the administrative functions.</span>
restrict 127.0.0.1
restrict -6 ::1

&lt;% ntpServerList.each <span class="k">do</span> <span class="p">|</span>ntpServer<span class="p">|</span> -%&gt;
server &lt;%<span class="o">=</span> ntpServer %&gt;
&lt;% end -%&gt;

<span class="c"># Drift file.  Put this in a directory which the daemon can write to.</span>
<span class="c"># No symbolic links allowed, either, since the daemon updates the file</span>
<span class="c"># by creating a temporary in the same directory and then rename()&#39;ing</span>
<span class="c"># it to the file.</span>
driftfile /var/lib/ntp/drift
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<p>This .erb file is a ruby template describing what the file /etc/ntp.conf should contain. The magic of this is the section:</p>

<div class="highlight"><pre><code class="bash">&lt;% ntpServerList.each <span class="k">do</span> <span class="p">|</span>ntpServer<span class="p">|</span> -%&gt;
server &lt;%<span class="o">=</span> ntpServer %&gt;
&lt;% end -%&gt;
</code></pre></div>

<p>This section is actually ruby code that runs a foreach loop on the array &quot;ntpServerList&quot; and adds a line for each ntp server contained in that array. </p>

<h4>H. Run the tree command and you should see the following file/directory structure:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># tree</span>
.
├── example_box
│   └── dummy.box
├── manifests
│   └── site.pp
├── modules
│   ├── common
│   │   └── manifests
│   │       └── init.pp
│   └── ntp
│       ├── manifests
│       │   └── init.pp
│       └── templates
│           └── client-ntp.conf.erb
└── Vagrantfile

8 directories, 6 files
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<h3>2. Modify the Vagrantfile we created in the last post to include the following:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># cat Vagrantfile</span>
Vagrant.configure<span class="o">(</span><span class="s2">&quot;2&quot;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
  config.vm.box <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
  config.vm.box_url <span class="o">=</span> <span class="s1">&#39;./example_box/dummy.box&#39;</span>

  config.vm.provider :vsphere <span class="k">do</span> <span class="p">|</span>vsphere<span class="p">|</span>
    vsphere.host <span class="o">=</span> <span class="s1">&#39;192.168.1.195&#39;</span>
    vsphere.name <span class="o">=</span> <span class="s1">&#39;vagrant-test&#39;</span>
    vsphere.clone_from_vm <span class="o">=</span> <span class="nb">true</span>
<span class="nb">    </span>vsphere.template_name <span class="o">=</span> <span class="s1">&#39;vagrant-centos-6.5&#39;</span>
    vsphere.user <span class="o">=</span> <span class="s1">&#39;root@localos&#39;</span>
    vsphere.password <span class="o">=</span> <span class="s1">&#39;S0meR@nd0mP@ssw0rd&#39;</span>
    vsphere.insecure <span class="o">=</span> <span class="nb">true</span>
<span class="nb">    </span>vsphere.data_store_name <span class="o">=</span> <span class="s1">&#39;vsanDatastore&#39;</span>
    vsphere.linked_clone <span class="o">=</span> <span class="nb">true</span>
<span class="nb">    </span>vsphere.customization_spec_name <span class="o">=</span> <span class="s1">&#39;vagrant-centos&#39;</span>
  end
  config.vm.provision <span class="s2">&quot;puppet&quot;</span> <span class="k">do</span> <span class="p">|</span>puppet<span class="p">|</span>
    puppet.manifests_path <span class="o">=</span> <span class="s2">&quot;manifests&quot;</span>
    puppet.manifest_file <span class="o">=</span> <span class="s2">&quot;site.pp&quot;</span>
    puppet.module_path <span class="o">=</span> <span class="s2">&quot;modules&quot;</span>
  end
end
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<p>The following new lines have been added:</p>

<ul>
<li>&quot;puppet.manifests_path&quot; specifies the sub-directory, from the directory containing the Vagrantfile, that contains the puppet manifests.</li>
<li>&quot;puppet.manifest_file&quot; specifies the puppet manifest that will be initially run.</li>
<li>&quot;puppet.module_path&quot; specifies the sub-directory, from the directory containing the Vagrantfile, that contains the puppet modules.</li>
</ul>

<h3>3. Test the configuration changes we made by running a &quot;vagrant up&quot;:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant up --provider=vsphere</span>
Bringing machine <span class="s1">&#39;default&#39;</span> up with <span class="s1">&#39;vsphere&#39;</span> provider...
<span class="o">==</span>&gt; default: Calling vSphere CloneVM with the following settings:
<span class="o">==</span>&gt; default:  -- Source VM: vagrant-centos-6.5
<span class="o">==</span>&gt; default:  -- Name: vagrant-test
<span class="o">==</span>&gt; default: Waiting <span class="k">for </span>SSH to become available...
<span class="o">==</span>&gt; default: New virtual machine successfully cloned and <span class="nv">started</span>
<span class="o">==</span>&gt; default: Rsyncing folder: /root/vagrant-vms/ <span class="o">=</span>&gt; /vagrant
<span class="o">==</span>&gt; default: Rsyncing folder: /root/vagrant-vms/manifests/ <span class="o">=</span>&gt; /tmp/vagrant-puppet-1/manifests
<span class="o">==</span>&gt; default: Rsyncing folder: /root/vagrant-vms/modules/ <span class="o">=</span>&gt; /tmp/vagrant-puppet-1/modules-0
<span class="o">==</span>&gt; default: Running provisioner: puppet...
Running Puppet with site.pp...
notice: /File<span class="o">[</span>/etc/ntp.conf<span class="o">]</span>/content: content changed <span class="s1">&#39;{md5}d7e1e16f9c0cd6382f6b68b486163db1&#39;</span> to <span class="s1">&#39;{md5}f7a83a4ca84e1ba2bba0166c5620e9e7&#39;</span>
notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Ntp/Service<span class="o">[</span>ntpd<span class="o">]</span>: Triggered <span class="s1">&#39;refresh&#39;</span> from 1 events
notice: Finished catalog run in 0.72 seconds
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<p>You might notice a few new lines since the &quot;vagrant up&quot; we ran in the last post. </p>

<ul>
<li>The manifests &amp; modules folders we specified in Vagrantfile have been copied over using rsync. </li>
<li>The Puppet agent is running a &quot;puppet apply&quot; using the site.pp file we specified. </li>
<li>/etc/ntp.conf was modified by Puppet</li>
<li>The NTP service was notified that it needed to refresh it&#39;s configuration since /etc/ntp.conf had been modified.</li>
</ul>

<h3>4. Connect to the vagrant vm to validate that /etc/ntp.conf has been modified to include the three NTP servers we specified:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant ssh</span>
<span class="o">[</span>vagrant@vagrant-test ~<span class="o">]</span><span class="nv">$ </span>cat /etc/ntp.conf
<span class="c"># This file is being maintained by Puppet.</span>
<span class="c"># DO NOT EDIT</span>

<span class="c"># Permit time synchronization with our time source, but do not</span>
<span class="c"># permit the source to query or modify the service on this system.</span>
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery

<span class="c"># Permit all access over the loopback interface.  This could</span>
<span class="c"># be tightened as well, but to do so would effect some of</span>
<span class="c"># the administrative functions.</span>
restrict 127.0.0.1
restrict -6 ::1

server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst
server 2.pool.ntp.org iburst

<span class="c"># Drift file.  Put this in a directory which the daemon can write to.</span>
<span class="c"># No symbolic links allowed, either, since the daemon updates the file</span>
<span class="c"># by creating a temporary in the same directory and then rename()&#39;ing</span>
<span class="c"># it to the file.</span>
driftfile /var/lib/ntp/drift
<span class="o">[</span>vagrant@vagrant-test ~<span class="o">]</span><span class="nv">$ </span><span class="nb">exit</span>
<span class="nb">logout</span>
Connection to 192.168.1.123 closed.
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<h3>5. Modify the site.pp file to add a node definition for our vagrant vm:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># cat site.pp</span>
node default <span class="o">{</span>
  include common
    class <span class="o">{</span><span class="s1">&#39;ntp&#39;</span>:<span class="o">}</span>
<span class="o">}</span>
node <span class="s1">&#39;vagrant-test.mylab.net&#39;</span> <span class="o">{</span>
  include common
    class <span class="o">{</span><span class="s1">&#39;ntp&#39;</span>:
      <span class="nv">ntpServerList</span> <span class="o">=</span>&gt; <span class="o">[</span><span class="s1">&#39;3.pool.ntp.org&#39;</span>,<span class="s1">&#39;4.pool.ntp.org&#39;</span>,<span class="s1">&#39;5.pool.ntp.org&#39;</span><span class="o">]</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>The new &quot;node &#39;vagrant-test.mylab.net&#39;&quot; definition will only be run by hosts with a matching hostname. Any host that doesn&#39;t have a matching host definition will continue to run the &quot;node default&quot; section. Node definitions allow you to change variables or even modules that will be run by specific hosts and provide flexibility in the changes made to a given host. Our new node section will configure &quot;vagrant-test.mylab.net&quot; to use a different set of ntp servers than any other host that runs this Puppet manifest  </p>

<h3>6. Run &#39;vagrant provision&#39; to apply the updated Puppet manifest to our Vagrant vm:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant provision</span>
<span class="o">==</span>&gt; default: Rsyncing folder: /root/vagrant-vms/ <span class="o">=</span>&gt; /vagrant
<span class="o">==</span>&gt; default: Rsyncing folder: /root/vagrant-vms/manifests/ <span class="o">=</span>&gt; /tmp/vagrant-puppet-1/manifests
<span class="o">==</span>&gt; default: Rsyncing folder: /root/vagrant-vms/modules/ <span class="o">=</span>&gt; /tmp/vagrant-puppet-1/modules-0
<span class="o">==</span>&gt; default: Running provisioner: puppet...
Running Puppet with site.pp...
notice: /File<span class="o">[</span>/etc/ntp.conf<span class="o">]</span>/content: content changed <span class="s1">&#39;{md5}f7a83a4ca84e1ba2bba0166c5620e9e7&#39;</span> to <span class="s1">&#39;{md5}414e811fdbfa3f8cfa38e1e4e6d0586f&#39;</span>
notice: /Stage<span class="o">[</span>main<span class="o">]</span>/Ntp/Service<span class="o">[</span>ntpd<span class="o">]</span>: Triggered <span class="s1">&#39;refresh&#39;</span> from 1 events
notice: Finished catalog run in 0.34 seconds
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c">#</span>
</code></pre></div>

<p>While we could have destroyed and recreated our Vagrant vm to test the change to the Puppet manifest, &#39;vagrant provision&#39; quickly resyncs the folders defined in our Vagrantfile and re-runs our Puppet manifest.</p>

<h3>7. Connect to the vagrant vm to validate that /etc/ntp.conf has been modified to include the three NTP servers we defined fof this specific node:</h3>

<div class="highlight"><pre><code class="bash">root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant ssh</span>
Last login: Tue May  6 15:09:50 2014 from 192.168.1.40
<span class="o">[</span>vagrant@vagrant-test ~<span class="o">]</span><span class="nv">$ </span>cat /etc/ntp.conf
<span class="c"># This file is being maintained by Puppet.</span>
<span class="c"># DO NOT EDIT</span>

<span class="c"># Permit time synchronization with our time source, but do not</span>
<span class="c"># permit the source to query or modify the service on this system.</span>
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery

<span class="c"># Permit all access over the loopback interface.  This could</span>
<span class="c"># be tightened as well, but to do so would effect some of</span>
<span class="c"># the administrative functions.</span>
restrict 127.0.0.1
restrict -6 ::1

server 3.pool.ntp.org iburst
server 4.pool.ntp.org iburst
server 5.pool.ntp.org iburst

<span class="c"># Drift file.  Put this in a directory which the daemon can write to.</span>
<span class="c"># No symbolic links allowed, either, since the daemon updates the file</span>
<span class="c"># by creating a temporary in the same directory and then rename()&#39;ing</span>
<span class="c"># it to the file.</span>
driftfile /var/lib/ntp/drift
<span class="o">[</span>vagrant@vagrant-test ~<span class="o">]</span><span class="nv">$ </span><span class="nb">exit</span>
<span class="nb">logout</span>
Connection to 192.168.1.123 closed.
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c">#</span>
</code></pre></div>

<h3>8. Shutdown the vagrant machine:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant destroy</span>
<span class="o">==</span>&gt; default: Calling vSphere <span class="nv">PowerOff</span>
<span class="o">==</span>&gt; default: Calling vShpere Destroy
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c">#</span>
</code></pre></div>

<h3>Hopefully you found this post helpful in demonstrating how to use Puppet with Vagrant, as well as the benefits it provides for testing Puppet manfests and modules</h3>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/04/24/vagrant-and-vcenter-guest-customization/">
        Using advanced vagrant-vsphere provider settings and vCenter guest customization
      </a>
    </h1>

    <span class="post-date">24 Apr 2014</span>

    <p>This post will pick up where we left off by demonstrating more vagrant-vsphere provider settings using the CentOS template we customized in the last blog post. Let&#39;s get started:</p>

<h3>1. Create a new customization specification in the vSphere web client. This customization specification will allow us to set the hostname of the vm created by &quot;vagrant up&quot; to the same name as the virtual machine.</h3>

<h4>A. Go to Home | Customization Specification Manager:</h4>

<p><img src="/assets/01-web-client-home.jpg" alt="screenshot"></p>

<h4>B. Click the &quot;Create a new specification&quot; button:</h4>

<p><img src="/assets/02-create-guest-customization.jpg" alt="screenshot"></p>

<h4>C. Select &quot;Linux&quot; for the &quot;Target VM Operating System&quot; and name the customization specification. Click &quot;Next&quot; to continue</h4>

<p><img src="/assets/03-new-guest-customization.jpg" alt="screenshot"></p>

<h4>D. For &quot;Computer Name&quot; select &quot;Use the virtual machine name&quot; and click &quot;Next&quot; to continue.</h4>

<p><img src="/assets/04-set-computer-name.jpg" alt="screenshot"></p>

<h4>E. For &quot;Time Zone&quot; select the time zone you want to use and click &quot;Next&quot; to continue.</h4>

<p><img src="/assets/05-set-timezone.jpg" alt="screenshot"></p>

<h4>F. For &quot;Configure Network&quot; keep the default and click &quot;Next to continue.</h4>

<p><img src="/assets/06-configure-network.jpg" alt="screenshot"></p>

<h4>G. For &quot;Enter DNS and Domain settings&quot; enter the DNS servers and the domain name you want to assign to the cloned vm. Click &quot;Next to continue.</h4>

<p><img src="/assets/07-dns-settings.jpg" alt="screenshot"></p>

<h4>H. Click &quot;Finish&quot; to create the customization specification.</h4>

<p><img src="/assets/08-finish.jpg" alt="screenshot"></p>

<h3>2. Modify the Vagrantfile we created in the initial &quot;<a href="http://sdorsett.github.io/2014/04/19/vagrant-install/">Installing Vagrant and the vagrant-vsphere plugin on CentOS 6.x</a>&quot; post.</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># cat Vagrantfile</span>
Vagrant.configure<span class="o">(</span><span class="s2">&quot;2&quot;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
  config.vm.box <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
  config.vm.box_url <span class="o">=</span> <span class="s1">&#39;./example_box/dummy.box&#39;</span>

  config.vm.provider :vsphere <span class="k">do</span> <span class="p">|</span>vsphere<span class="p">|</span>
    vsphere.host <span class="o">=</span> <span class="s1">&#39;192.168.1.195&#39;</span>
    vsphere.name <span class="o">=</span> <span class="s1">&#39;vagrant-test&#39;</span>
    vsphere.clone_from_vm <span class="o">=</span> <span class="nb">true</span>
<span class="nb">    </span>vsphere.template_name <span class="o">=</span> <span class="s1">&#39;vagrant-centos-6.5&#39;</span>
    vsphere.user <span class="o">=</span> <span class="s1">&#39;root@localos&#39;</span>
    vsphere.password <span class="o">=</span> <span class="s1">&#39;S0meR@nd0mP@ssw0rd&#39;</span>
    vsphere.insecure <span class="o">=</span> <span class="nb">true</span>
<span class="nb">    </span>vsphere.data_store_name <span class="o">=</span> <span class="s1">&#39;vsanDatastore&#39;</span>
    vsphere.linked_clone <span class="o">=</span> <span class="nb">true</span>
<span class="nb">    </span>vsphere.customization_spec_name <span class="o">=</span> <span class="s1">&#39;vagrant-centos&#39;</span>
  end
end
</code></pre></div>

<p>The following new lines have been added:</p>

<ul>
<li>&quot;vsphere.data_store_name&quot; is the datastore that the cloned vm will be deployed to.</li>
<li>&quot;vsphere.linked_clone&quot; being set to &quot;true&quot; will cause the cloned vm to be deployed as a linked clone. This will dramatically decrease the amount of time needed to clone the vm when &quot;vagrant up&quot; command is issued.</li>
<li>&quot;vsphere.customization_spec_name&quot; will specify the customization specification that will be applied to the cloned vm. Set this to the customization specification we created in the previous step.</li>
</ul>

<h3>3. Test the configuration changes we made by running a &quot;vagrant up&quot;:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant up --provider=vsphere</span>
Bringing machine <span class="s1">&#39;default&#39;</span> up with <span class="s1">&#39;vsphere&#39;</span> provider...
<span class="o">==</span>&gt; default: Calling vSphere CloneVM with the following settings:
<span class="o">==</span>&gt; default:  -- Source VM: vagrant-centos-6.5
<span class="o">==</span>&gt; default:  -- Name: vagrant-test
<span class="o">==</span>&gt; default: Waiting <span class="k">for </span>SSH to become available...
<span class="o">==</span>&gt; default: New virtual machine successfully cloned and <span class="nv">started</span>
<span class="o">==</span>&gt; default: Rsyncing folder: /root/vagrant-vms/ <span class="o">=</span>&gt; /vagrant
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<p>You should find the time it took to deploy the linked clone vm was much faster than previous full clones of the vagrant template vm.</p>

<h3>4. Connect to the vagrant vm to validate the hostname of the vm matched the vm name &amp; search domain:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant ssh</span>
<span class="o">[</span>vagrant@vagrant-test ~<span class="o">]</span><span class="nv">$ </span>hostname -f
vagrant-test.mylab.net
<span class="o">[</span>vagrant@vagrant-test ~<span class="o">]</span><span class="nv">$ </span><span class="nb">exit</span>
<span class="nb">logout</span>
Connection to 192.168.1.117 closed.
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<h3>5. Clean up after ourselves and call it a day:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant destroy</span>
<span class="o">==</span>&gt; default: Calling vSphere <span class="nv">PowerOff</span>
<span class="o">==</span>&gt; default: Calling vShpere Destroy
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c">#</span>
</code></pre></div>

<p>You might be wondering why setting the hostname &amp; domain name might be so important. We will see in future posts how to use hostnames to determine which manifests will be applied to specific vms we clone and power up with Vagrant.</p>

<h3>Hopefully you found this post helpful understanding more about the usefulness of customization specifications and advanced vagrant-vsphere configurations. The next blog post will start diving into using Vagrant to test Puppet manifests.</h3>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2014/04/20/vagrant-boxes/">
        Creating a CentOS 6.x template that is customized for Vagrant
      </a>
    </h1>

    <span class="post-date">20 Apr 2014</span>

    <p>This post will continue our examination of using the vagrant-vsphere plugin, by customizing a CentOS template for integration with Vagrant. Having a Vagrant customize template will allow us to deploy this template and SSH to the cloned vm using the &quot;vagrant ssh&quot; command, as well automatically run puppet manifests when we deploy a vm using Vagrant. Let&#39;s get started:</p>

<h3>1. Ensure you have a DHCP server on the network you will be connecting the Vagrant deployed templates to. While you can utilized guest customization to assign a static IP addresses to a Vagrant deployed vm, using DHCP will make this process much easier.</h3>

<h3>2. Create a CentOS 6.x minimal virtual machine for configuring as our Vagrant CentOS template.</h3>

<p>Create or clone a fresh CentOS 6.x minimal virtual machine. I already have an existing Centos 6.5 minimal template that I simply cloned for this purpose.</p>

<h3>3. Power on the new cloned vm and connect using SSH to the DHCP assigned IP address for this vm.</h3>

<h3>4. Ensure you have perl, rsync, ruby &amp; puppet agent installed:</h3>

<h4>A. Import the EPEL 6 key and RPM:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># rpm --import http://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-6</span>
<span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># rpm -Kih http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
<span class="c">########################################### [100%]</span>
<span class="c">########################################### [100%]</span>
</code></pre></div>

<h4>B. Use yum to install ruby, wget, puppet, facter &amp; rsync:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># yum install ruby ruby-libs ruby-shad wget yum-priorities puppet facter rsync -y</span>
</code></pre></div>

<h3>5. Ensure you have vmtools installed on the new CentOS template.</h3>

<h4>A. Start the install process by clicking &quot;VM | Guest | Install/Upgrade VMware Tools&quot; in the vShpere client. When prompted select &quot;Automatice Tools Upgrade&quot; and click &quot;OK&quot;</h4>

<h4>B. Create a directory to mount the virtual CDROM to with the following command:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># mkdir /mnt/cdrom</span>
</code></pre></div>

<h4>C. Mount the virtual CDROM to /mnt/cdrom with the following command:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># mount /dev/cdrom /mnt/cdrom</span>
mount: block device /dev/sr0 is write-protected, mounting <span class="nb">read</span>-only
</code></pre></div>

<h4>D. Copy the VMware Tools installer over to the /root directory and unzip it:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># cp /mnt/cdrom/VMwareTools-* ~/</span>
<span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># tar -zxf ~/VMwareTools*</span>
</code></pre></div>

<h4>E. Change directory into the directory we just untared and run the &quot;vmware-install.pl&quot; to start the installer:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># cd vmware-tools-distrib/</span>
<span class="o">[</span>root@centos-6-5 vmware-tools-distrib<span class="o">]</span><span class="c"># ./vmware-install.pl</span>
</code></pre></div>

<p>You should be able to accept the defaults for all prompts and complete the VMware tools installer. Once the installer has completed check the vm summary of this template vm in the vSphere client. The VMware Tools should show as &quot;Running&quot; and &quot;Current.&quot;</p>

<h4>F. Unmount the virtual CDROM using the following command:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># umount /dev/cdrom</span>
</code></pre></div>

<h3>6. We will next follow the steps for <a href="https://docs.vagrantup.com/v2/boxes/base.html">creating a base box</a> from the Vagrant website.</h3>

<p>One thing to point out is we will be configuring the vagrant template for password less SSH using a vagrant user with the password of &quot;vagrant.&quot; The Vagrant website mentions &#39;by default, Vagrant expects a &quot;vagrant&quot; user to SSH into the machine as. This user should be setup with the insecure keypair that Vagrant uses as a default to attempt to SSH. Also, even though Vagrant uses key-based authentication by default, it is a general convention to set the password for the &quot;vagrant&quot; user to &quot;vagrant.&quot;&#39;</p>

<p>This vagrant template should only be used for lab or development work and never used for production or publicly facing virtual machines due to the security risks of having known users, passwords &amp; private SSH keys configured by default. </p>

<h4>A. Add a new user named &quot;vagrant&quot; to the template.</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># useradd vagrant</span>
</code></pre></div>

<h4>B. Change the password of the user &quot;vagrant&quot; to &quot;vagrant&quot;</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># [root@centos-6-5 ~]# passwd vagrant</span>
Changing password <span class="k">for </span>user vagrant.
New password: &lt;<span class="nb">type </span>the word <span class="s2">&quot;vagrant&quot;</span>&gt;
BAD PASSWORD: it is based on a dictionary word
BAD PASSWORD: is too simple
Retype new password: &lt;<span class="nb">type </span>the word <span class="s2">&quot;vagrant&quot;</span> again&gt;
passwd: all authentication tokens updated successfully.
</code></pre></div>

<h4>C. We will next need to copy the contents of the vagrant.pub file located at the <a href="9https://github.com/mitchellh/vagrant/tree/master/keys">vagrant github site</a> into the /home/vagrant/.ssh/authorized_keys file.</h4>

<p>First we will su (switch user) to the vagrant user by running the following command:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># su vagrant</span>
<span class="o">[</span>vagrant@centos-6-5 root<span class="o">]</span><span class="nv">$ </span>
</code></pre></div>

<p>Next we will create the .ssh directory since is does not exist:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>vagrant@centos-6-5 root<span class="o">]</span><span class="nv">$ </span>mkdir ~/.ssh
<span class="o">[</span>vagrant@centos-6-5 root<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ~/.ssh
<span class="o">[</span>vagrant@centos-6-5 .ssh<span class="o">]</span><span class="nv">$ </span><span class="nb">pwd</span>
/home/vagrant/.ssh
</code></pre></div>

<p>We will now create /home/vagrant/.ssh/authorized_keys with the contents of <a href="https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub">this file</a> from the vagrant github page:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>vagrant@centos-6-5 .ssh<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key&#39;</span> &gt; ~/.ssh/authorized_keys
<span class="o">[</span>vagrant@centos-6-5 .ssh<span class="o">]</span><span class="nv">$ </span>cat ~/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ<span class="o">==</span> vagrant insecure public key
</code></pre></div>

<p>The vagrant website also mentions &#39;that OpenSSH is very picky about file permissions. Therefore, make sure that ~/.ssh has 0700 permissions and the authorized keys file has 0600 permissions.&#39; We will correct those permissions now:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>vagrant@centos-6-5 .ssh<span class="o">]</span><span class="nv">$ </span><span class="nb">cd</span> ~/
<span class="o">[</span>vagrant@centos-6-5 ~<span class="o">]</span><span class="nv">$ </span>chmod 700 ~/.ssh
<span class="o">[</span>vagrant@centos-6-5 ~<span class="o">]</span><span class="nv">$ </span>chmod 600 ~/.ssh/authorized_keys
<span class="o">[</span>vagrant@centos-6-5 ~<span class="o">]</span><span class="nv">$ </span>ls -la
total 24
drwx------. 3 vagrant vagrant 4096 Apr 20 14:22 .
drwxr-xr-x. 3 root    root    4096 Apr 20 14:15 ..
-rw-r--r--. 1 vagrant vagrant   18 Jul 18  2013 .bash_logout
-rw-r--r--. 1 vagrant vagrant  176 Jul 18  2013 .bash_profile
-rw-r--r--. 1 vagrant vagrant  124 Jul 18  2013 .bashrc
drwx------. 2 vagrant vagrant 4096 Apr 20 14:26 .ssh
<span class="o">[</span>vagrant@centos-6-5 ~<span class="o">]</span><span class="nv">$ </span>ls -la .ssh
total 12
drwx------. 2 vagrant vagrant 4096 Apr 20 14:26 .
drwx------. 3 vagrant vagrant 4096 Apr 20 14:22 ..
-rw-------. 1 vagrant vagrant  409 Apr 20 14:26 authorized_keys
<span class="o">[</span>vagrant@centos-6-5 ~<span class="o">]</span><span class="nv">$ </span><span class="nb">exit</span>
<span class="nb">exit</span>
<span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c">#</span>
</code></pre></div>

<h4>D. We will to edit the sudo file. Type the following command to open the sudo file in vi:</h4>

<div class="highlight"><pre><code class="bash">root@centos-6-5 ~<span class="o">]</span><span class="c"># visudo</span>
</code></pre></div>

<p>Locate the line containing:</p>

<div class="highlight"><pre><code class="bash">Defaults    requiretty
</code></pre></div>

<p>...and change it to read:</p>

<div class="highlight"><pre><code class="bash"><span class="c"># Defaults    requiretty&#39;</span>
</code></pre></div>

<p>The # sign at the beginning of the line will cause this line to be ignored as a comment.
We also need to add the following line at the bottom of the file:</p>

<div class="highlight"><pre><code class="bash">vagrant <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD: ALL
</code></pre></div>

<h4>E. One more recommendation from the vagrant website is to edit /etc/ssh/sshd_config and change any line matching:</h4>

<div class="highlight"><pre><code class="bash">UseDNS yes
</code></pre></div>

<p>to </p>

<div class="highlight"><pre><code class="bash">UseDNS no
</code></pre></div>

<p>This avoids a reverse DNS lookup on the connecting SSH client which can take many seconds.</p>

<h3>7. Lastly this is a template, so we will need to remove /etc/udev/rules.d/70-persistent-net.rules file because it contains the MAC address of the current virtual NIC. It will be recreated on boot up or when we deploy other virtual machines from this template.</h3>

<h3>8. We will now shutdown the template by running halt:</h3>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@centos-6-5 ~<span class="o">]</span><span class="c"># halt</span>
Broadcast message from root@centos-6-5
    <span class="o">(</span>/dev/pts/1<span class="o">)</span> at 14:51 ...
The system is going down <span class="k">for </span>halt NOW!
</code></pre></div>

<h3>9. We now need to SSH to the vagrant vm that has the vagrant-vsphere plugin installed. This is the vm we created if you followed the <a href="https://sdorsett.github.io/2014/04/19/vagrant-install/">last blog post.</a></h3>

<h4>A. Edit the Vagrantfile we created to modify the following line to reflect the name you gave the new vagrant template we cloned or created in the steps above:</h4>

<div class="highlight"><pre><code class="bash">vsphere.template_name <span class="o">=</span> <span class="s1">&#39;vagrant-centos-6.5&#39;</span>
</code></pre></div>

<h4>B. We can test this new template by issuing the following command:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant up --provider=vsphere</span>
Bringing machine <span class="s1">&#39;default&#39;</span> up with <span class="s1">&#39;vsphere&#39;</span> provider...
<span class="o">==</span>&gt; default: Calling vSphere CloneVM with the following settings:
<span class="o">==</span>&gt; default:  -- Source VM: vagrant-centos-6.5
<span class="o">==</span>&gt; default:  -- Name: vagrant-test
<span class="o">==</span>&gt; default: Waiting <span class="k">for </span>SSH to become available...
<span class="o">==</span>&gt; default: New virtual machine successfully cloned and <span class="nv">started</span>
<span class="o">==</span>&gt; default: Rsyncing folder: /root/vagrant-vms/ <span class="o">=</span>&gt; /vagrant
</code></pre></div>

<p>Unlike our &#39;vagrant up&quot; command in the last post we have established a SSH session with the cloned template using the vagrant user we created and the public key in that users authorized_keys file.</p>

<p>You also might notice that the entire directory we launched the &#39;vagrant up&quot; command from has been copied over to /vagrant on the cloned vm using rsync. We will go into leveraging this feature with puppet in our next blog post.</p>

<h4>C. Using SSH to connect to the vagrant vm is as easy as &#39;vagrant ssh&#39;</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># hostname</span>
vagrant.mylab.net
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant ssh</span>
<span class="o">[</span>vagrant@vagrant-centos-6-5 ~<span class="o">]</span><span class="nv">$ </span>hostname
vagrant-centos-6-5
<span class="o">[</span>vagrant@vagrant-centos-6-5 ~<span class="o">]</span><span class="nv">$ </span><span class="nb">exit</span>
<span class="nb">logout</span>
Connection to 192.168.1.133 closed.
<span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># </span>
</code></pre></div>

<h4>D. Finally we will power down and delete the cloned template by running the following command:</h4>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@vagrant vagrant-vms<span class="o">]</span><span class="c"># vagrant destroy</span>
<span class="o">==</span>&gt; default: Calling vSphere <span class="nv">PowerOff</span>
<span class="o">==</span>&gt; default: Calling vShpere Destroy
</code></pre></div>

<h3>Hopefully you found this post helpful in demonstrating how to create a vagrant specific template to use with the vagrant-vsphere plugin. The next blog post will be covering how to take advantage of customization specifications and advanced Vagrantfile configurations on a vm deployed using vagrant.</h3>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
