<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      sdorsett.github.io &middot; Things I find interesting
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="/">Home</a>

    

    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/posts/">All Posts</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
    <a class="sidebar-nav-item" href="https://github.com/sdorsett/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="https://github.com/sdorsett">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2018. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">sdorsett.github.io</a>
            <small>Things I find interesting</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/08/14/using-rclone-to-connect-to-ovh-public-cloud-swift-storage/">
        Using rclone to manage OVH Public Cloud swift storage
      </a>
    </h1>

    <span class="post-date">14 Aug 2018</span>

    <p>This is the third in a series of posts that will walk you through using the Openstack-based OVH public cloud. In this post you will get introduced to using rclone to upload and retrieve files from the Openstack swift API. </p>

<p>This post is assumes you have already signed up for an account with ovhcloud.com, added a payment method, created a cloud project and created an Openstack user. If you have not done these steps you can follow the steps in <a href="http://sdorsett.github.io/2018/08/08/creating-an-openstack-instance-on-ovh-public-cloud/">the first</a> and <a href="http://sdorsett.github.io/2018/08/10/using-the-openstack-cli-to-create-a-server-on-ovh-public-cloud/">second blog post</a> in this series that will walk you through completing those steps.</p>

<p>I will attempt in this post to present the options that are available to OVH public cloud customers along side the choices I made that were specific to my Openstack server.</p>

<p>Let&#39;s get started...</p>

<hr>

<h2>1. Sign into <a href="https://ovhcloud.com/auth/">ovhcloud.com</a>.</h2>

<p>The first thing you will need to do before you can move forward with this post is sign into <a href="https://ovhcloud.com/auth/">https://ovhcloud.com/auth/</a> using the account you created in the first blog post..</p>

<p><img src="/assets/08102018-01-login-username-password.png" alt="screenshot"></p>

<p>If you setup two-factor authentication, you will be prompted to enter the current two-factor token.</p>

<p><img src="/assets/08102018-02-login-two-factor.png" alt="screenshot"></p>

<h2>2. Create a object container.</h2>

<p>The first step to store files in your OVH Public Cloud will be to create a swift object container to store the files. Object containers are managed by clicking the <code>storage</code> tab of the cloud project you want to store files in.</p>

<p><img src="/assets/08142018-01-openstack-storage-empty.png" alt="screenshot"></p>

<p>If you do not have any object containers create, you can create one by clicking the <code>Create a container</code> button.</p>

<p><img src="/assets/08142018-02-openstack-create-object-container.png" alt="screenshot"></p>

<p>Select the datacenter you want to create the object container in.</p>

<p><img src="/assets/08142018-03-openstack-create-object-container.png" alt="screenshot"></p>

<p>Select what purpose for which you are intending to use the object container storage. I am intending to test file that need to be publicly available, without any sort of authentication, so I chose <code>Public</code>. </p>

<p>Name the object container a name that reflects it&#39;s purpose and click <code>Create the container</code></p>

<p><img src="/assets/08142018-04-openstack-create-object-container.png" alt="screenshot"></p>

<p>You will next be taken to a view that lists the details of the newly created object container.</p>

<p><img src="/assets/08142018-05-openstack-create-object-container.png" alt="screenshot"></p>

<h2>3. Install rclone</h2>

<p>Rclone is self described as &#39;a command line program to sync files and directories to and from cloud storage.&#39; It is opensource and is compatible with Openstack swift, so it will work with OVH Public Cloud object containers.</p>

<p>The first thing you need to do is download the latest version for your operating system from the <a href="https://rclone.org/downloads/">rclone download page</a>, unzip the binary and place it within our path.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ cd ~/Downloads/
MacBook-Pro:Downloads standorsett$ wget https://downloads.rclone.org/v1.42/rclone-v1.42-osx-amd64.zip
--2018-08-14 13:50:18--  https://downloads.rclone.org/v1.42/rclone-v1.42-osx-amd64.zip
Resolving downloads.rclone.org (downloads.rclone.org)... 5.153.250.7
Connecting to downloads.rclone.org (downloads.rclone.org)|5.153.250.7|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 9748516 (9.3M) [application/zip]
Saving to: ‘rclone-v1.42-osx-amd64.zip’

rclone-v1.42-osx-amd64.zip                    100%[==============================================================================================&gt;]   9.30M   574KB/s    in 37s

2018-08-14 13:50:56 (255 KB/s) - ‘rclone-v1.42-osx-amd64.zip’ saved [9748516/9748516]

MacBook-Pro:Downloads standorsett$</code></pre></figure>

<p>...unzip the binary,</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:Downloads standorsett$ unzip rclone-v1.42-osx-amd64.zip
Archive:  rclone-v1.42-osx-amd64.zip
   creating: rclone-v1.42-osx-amd64/
  inflating: rclone-v1.42-osx-amd64/README.html
  inflating: rclone-v1.42-osx-amd64/rclone
  inflating: rclone-v1.42-osx-amd64/rclone.1
  inflating: rclone-v1.42-osx-amd64/README.txt
MacBook-Pro:Downloads standorsett$</code></pre></figure>

<p>...and place it within a folder that is exported in your path.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:Downloads standorsett$ sudo cp rclone-v1.42-osx-amd64/rclone /usr/local/bin/
MacBook-Pro:Downloads standorsett$ which rclone
/usr/local/bin/rclone
MacBook-Pro:Downloads standorsett$ rclone --version
rclone v1.42
- os/arch: darwin/amd64
- go version: go1.10.1
MacBook-Pro:Downloads standorsett$
MacBook-Pro:Downloads standorsett$ cd ~/
MacBook-Pro:~ standorsett$</code></pre></figure>

<h2>4. Source the openrc.sh file you downloaded in the <a href="http://sdorsett.github.io/2018/08/10/using-the-openstack-cli-to-create-a-server-on-ovh-public-cloud/">previous blog post</a>.</h2>

<p>The simplest way to use rclone is to source the openrc.sh file you downloaded in the previous blog post. This will set environment variables that the rclone cli will use to connect to the OVH public cloud. When you source the openrc.sh file you will be prompted for the password of the Openstack user listed in this file.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ source ~/Downloads/openrc.sh
Please enter your OpenStack Password:
MacBook-Pro:~ standorsett$</code></pre></figure>

<h2>5. Export two RCLONE_CONFIG environment variables</h2>

<p>As mentioned on the <a href="https://rclone.org/swift/#using-an-alternate-authentication-method">rclone swift documentation</a> you can use rclone with swift without a config file by exporting two environment variables.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ export RCLONE_CONFIG_MYREMOTE_TYPE=swift
MacBook-Pro:~ standorsett$ export RCLONE_CONFIG_MYREMOTE_ENV_AUTH=true
MacBook-Pro:~ standorsett$</code></pre></figure>

<h2>6. Using rclone to list remote object containers.</h2>

<p>You can now list all remove object containers by running the command <code>rclone lsd myremote:</code></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ export RCLONE_CONFIG_MYREMOTE_TYPE=swift
MacBook-Pro:~ standorsett$ export RCLONE_CONFIG_MYREMOTE_ENV_AUTH=true
MacBook-Pro:~ standorsett$ rclone lsd myremote:
2018/08/14 13:23:16 NOTICE: Config file &quot;/Users/standorsett/.config/rclone/rclone.conf&quot; not found - using defaults
           0 2018-08-14 13:23:18         0 public_storage_container
MacBook-Pro:~ standorsett$</code></pre></figure>

<p>If you get tired of seeing the &#39;rclone.conf not found&#39; informational message, you can get rid of it by creating an empty config file with the same name mentioned.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ touch /Users/standorsett/.config/rclone/rclone.conf
MacBook-Pro:~ standorsett$ rclone lsd myremote:
           0 2018-08-14 13:23:40         0 public_storage_container
MacBook-Pro:~ standorsett$</code></pre></figure>

<p>You can see the command I ran returned the <code>public_storage_container</code> object container I created in step 2.</p>

<h2>6. Using rclone to upload files to the object container.</h2>

<p>Now that you have confirmed rclone is seeing to the OVH Public Cloud object container you created in step 2, you can upload a file to it. I decided to test with the rclone zip file for OSX that I downlaoded in step 3.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ rclone copy ~/Downloads/rclone-v1.42-osx-amd64.zip myremote:public_storage_container
MacBook-Pro:~ standorsett$</code></pre></figure>

<p>You can now run <code>rclone ls myremote:[object_container_name]</code> to list the contents of your object container. Here is the output of when I ran that command. I also decided to output the size of the file on the local disk to compare the two. Both the local and remote files contain the same number of bytes.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ rclone ls myremote:public_storage_container
  9748516 rclone-v1.42-osx-amd64.zip
MacBook-Pro:~ standorsett$ ls -la ~/Downloads/rclone-v1.42-osx-amd64.zip
-rw-r--r--@ 1 standorsett  staff  9748516 Jun 16 12:22 /Users/standorsett/Downloads/rclone-v1.42-osx-amd64.zip
MacBook-Pro:~ standorsett$</code></pre></figure>

<p>The file sizes of the local and remote files matched, but I also wanted to be safe and compare the local MD5 hashsum</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ md5 ~/Downloads/rclone-v1.42-osx-amd64.zip
MD5 (/Users/standorsett/Downloads/rclone-v1.42-osx-amd64.zip) = 6fc9f13129bd890164be65bc11f6c870
MacBook-Pro:~ standorsett$</code></pre></figure>

<p>...to the remote hashsum</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ rclone hashsum MD5 myremote:public_storage_container/rclone-v1.42-osx-amd64.zip
6fc9f13129bd890164be65bc11f6c870  rclone-v1.42-osx-amd64.zip
MacBook-Pro:~ standorsett$</code></pre></figure>

<p>...and verified that the two hashsums matched.</p>

<h2>7. Downloading the file from the public object container.</h2>

<p>If you created a public object container, all the files contained within the object container can be downloaded without providing any authentication. You should alway consider the purpose of the files being uploaded to the object container when deciding if it should be private or public.</p>

<p>You can test that the files can be access without any authentication. First confirm the file is visible in the ovhcloud.com UI.</p>

<p><img src="/assets/08142018-06-confirming-file-uploaded-in-ui.png" alt="screenshot"></p>

<p>You can then paste the <code>Container URL</code> displayed in the object container in a browser and see all the objects contained in it.</p>

<p><img src="/assets/08142018-07-confirming-file-uploaded-in-browser.png" alt="screenshot"></p>

<p>The final test you can do is to add the file name you uploaded to the container URL and test downloading the file.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ wget https://storage.us-east-va-1.cloud.ovh.us/v1/AUTH_2897923a654b40d0b8b36a502bda4a8f/public_storage_container/rclone-v1.42-osx-amd64.zip
--2018-08-14 22:21:38--  https://storage.us-east-va-1.cloud.ovh.us/v1/AUTH_2897923a654b40d0b8b36a502bda4a8f/public_storage_container/rclone-v1.42-osx-amd64.zip
Resolving storage.us-east-va-1.cloud.ovh.us (storage.us-east-va-1.cloud.ovh.us)... 147.135.3.101
Connecting to storage.us-east-va-1.cloud.ovh.us (storage.us-east-va-1.cloud.ovh.us)|147.135.3.101|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 9748516 (9.3M) [application/zip]
Saving to: ‘rclone-v1.42-osx-amd64.zip’

rclone-v1.42-osx-amd64.zip                    100%[==============================================================================================&gt;]   9.30M  2.45MB/s    in 4.3s

2018-08-14 22:21:42 (2.16 MB/s) - ‘rclone-v1.42-osx-amd64.zip’ saved [9748516/9748516]

MacBook-Pro:~ standorsett$</code></pre></figure>

<h2>8. Delete the uploaded file with rclone.</h2>

<p>Once you are finished with your test files, you should delete them to prevent being charged for their usage. You can delete the files by running the rclone command of <code>rclone deletefile remote:path</code>. Here is the output of when I ran this command and then listed out the files in my object container to verify it had been deleted..</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ rclone deletefile myremote:public_storage_container/rclone-v1.42-osx-amd64.zip
MacBook-Pro:~ standorsett$ rclone ls myremote:public_storage_container
MacBook-Pro:~ standorsett$</code></pre></figure>

<hr>

<h3>That all for this post covering how to use the rclone utility to manage your OVH public cloud swift storage.</h3>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/08/10/using-the-openstack-cli-to-create-a-server-on-ovh-public-cloud/">
        Using the Openstack cli to create a server on OVH public cloud
      </a>
    </h1>

    <span class="post-date">10 Aug 2018</span>

    <p>This is the second in a series of posts that will walk you through using the Openstack-based OVH public cloud. In this post you will get introduced to using the Openstack cli to create an Openstack server.</p>

<p>This post is assumes you have already signed up for an account with ovhcloud.com, added a payment method and created a cloud project. If you have not done these steps you can follow <a href="http://sdorsett.github.io/2018/08/08/creating-an-openstack-instance-on-ovh-public-cloud/">the first blog post</a> in this series that will walk you through completing those steps. </p>

<p>I will attempt in this post to present the options that are available to OVH public cloud customers along side the choices I made that were specific to my Openstack server.</p>

<p>Let&#39;s get started...</p>

<hr>

<h2>1. Sign into <a href="https://ovhcloud.com/auth/">ovhcloud.com</a>.</h2>

<p>The first thing you will need to do before you can move forward with this post is sign into <a href="https://ovhcloud.com/auth/">https://ovhcloud.com/auth/</a> using the account you created in the first blog post..</p>

<p><img src="/assets/08102018-01-login-username-password.png" alt="screenshot"></p>

<p>If you setup two-factor authentication, you will be prompted to enter the current two-factor token.</p>

<p><img src="/assets/08102018-02-login-two-factor.png" alt="screenshot"></p>

<h2>2. Create a new user account to use with the Openstack API.</h2>

<p>The Openstack API will not use the credentials you used to log into the ovhcloud.com site, but will instead use an Openstack user to create, modify or view objects in an OVH cloud project.</p>

<p>If have not created one already, you will need to create an Openstack user account within the cloud project you want to work with. You can display all the Openstack user accounts that have been created in a cloud project by clicking the &#39;Openstack&#39; tab within any cloud project. </p>

<p><img src="/assets/08102018-03-openstack-users.png" alt="screenshot"></p>

<p>Create a new user by clicking the &quot;Add user&quot; button.</p>

<p><img src="/assets/08102018-04-openstack-add-user.png" alt="screenshot"></p>

<p>Once you have specified the username and clicked &quot;Confirm&quot; you will be taken back to the Openstack tab. You will see the user you created and will also be able to see the password generated for this user for a short period of time. Make sure you record this password to a safe place since it will not be visible for very long. </p>

<p><img src="/assets/08102018-05-openstack-users-password-shown.png" alt="screenshot"></p>

<p>After a period of time you will no longer be able to see the password for the user you created, but If you do happen to forget the password, you can always have a new password regenerated.</p>

<p><img src="/assets/08102018-14-openstack-users-password-hidden.png" alt="screenshot"></p>

<h2>3. Download an Openstack configuration file.</h2>

<p>Now that you have an Openstack user created you can download an openrc.sh file that will contain all the details need by the Openstack cli to connect as this user. Click the &#39;...&#39; icon and the end of the line for the user you want to download a configuration file for and select &#39;Downloading an Openstack configuration file&#39;.</p>

<p><img src="/assets/08102018-06-download-openrc.png" alt="screenshot"></p>

<p>Select the region (datacenter) you want to connect to and click &#39;confirm&#39;. Your browser will next prompt you where you want to save the downloaded openrc.sh file.</p>

<p><img src="/assets/08102018-07-download-openrc-region.png" alt="screenshot"></p>

<p>If you look at the downloaded file you will see that it sets environment variables containing the Openstack details needed to connect to your cloud project.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:Desktop standorsett$ cat ~/Downloads/openrc.sh
#!/bin/bash

# To use an Openstack cloud you need to authenticate against keystone, which
# returns a **Token** and **Service Catalog**. The catalog contains the
# endpoint for all services the user/tenant has access to - including nova,
# glance, keystone, swift.
#
export OS_AUTH_URL=https://auth.cloud.ovh.us/v3/
export OS_IDENTITY_API_VERSION=3

export OS_USER_DOMAIN_NAME=${OS_USER_DOMAIN_NAME:-&quot;Default&quot;}
export OS_PROJECT_DOMAIN_NAME=${OS_PROJECT_DOMAIN_NAME:-&quot;Default&quot;}


# With the addition of Keystone we have standardized on the term **tenant**
# as the entity that owns the resources.
export OS_TENANT_ID=2897923a654b40d0b8b36a502bda4a8f
export OS_TENANT_NAME=&quot;3543682553721111&quot;

# In addition to the owning entity (tenant), openstack stores the entity
# performing the action as the **user**.
export OS_USERNAME=&quot;5r7jJyuwwwsv&quot;

# With Keystone you pass the keystone password.
echo &quot;Please enter your OpenStack Password: &quot;
read -sr OS_PASSWORD_INPUT
export OS_PASSWORD=$OS_PASSWORD_INPUT

# If your configuration has multiple regions, we set that information here.
# OS_REGION_NAME is optional and only valid in certain environments.
export OS_REGION_NAME=&quot;US-EAST-VA-1&quot;
# Do not leave a blank variable, unset it if it was empty
if [ -z &quot;$OS_REGION_NAME&quot; ]; then unset OS_REGION_NAME; fi
MacBook-Pro:Desktop standorsett$</code></pre></figure>

<p>The only piece of information that this file does not contain is your password, which it will prompt for when you source this file.</p>

<h2>4. Log into the Openstack Horizon UI.</h2>

<p>Just like you needed to create an Openstack user for interacting with the Openstack API, you will need to create a ssh keypair used for connecting to Openstack servers. This can be done within the Openstack Horizon UI. </p>

<p>Click the <code>...</code> icon and the end of the line for the user you want to use for interacting with the Openstack API and select <code>Launch Openstack Horizon</code>.</p>

<p><img src="/assets/08102018-08-launch-openstack-horizon.png" alt="screenshot"></p>

<p>This will open another browser tab for the Openstack Horizon UI with your username already filled in. Provide the password for this user and click <code>connect</code>.</p>

<p><img src="/assets/08102018-09-login-openstack-horizon.png" alt="screenshot"></p>

<h2>5. Create a ssh key-pair in the Openstack Horizon UI.</h2>

<p>We need to add a new ssh keypair that the Openstack API can add to servers that are created through the API. To keep things simple I added the same public ssh key that I generated in the first blog post.</p>

<p>To add a new ssh key pair go to <code>Project | Compute | Key pairs | Create Key Pair</code></p>

<p><img src="/assets/08102018-10-openstack-horizon-key-pairs.png" alt="screenshot"></p>

<p>Give the key pair a friendly name you can remember and paste the contents of the public key file. Click <code>Import Key Pair</code> to add this key pair.  </p>

<p><img src="/assets/08102018-12-openstack-horizon-import-key-pair.png" alt="screenshot"></p>

<p>The key pair you just added will now be visible in the Horizon UI.</p>

<p><img src="/assets/08102018-13-openstack-horizon-key-pairs.png" alt="screenshot"></p>

<h2>6. Installing the Openstack cli.</h2>

<p>You will need to install the openstack cli on the operating system you are using. You can easily find instruction for installing it on whatever OS you prefer to use. I quickly installed it on my Mac laptop with homebrew using the following commands.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">brew install python2
pip2 install --upgrade pip setuptools
pip2 install --upgrade python-openstackclient</code></pre></figure>

<h2>7. Sourcing the openrc.sh file</h2>

<p>The first step to using the Openstack cli you just installed is to source the openrc.sh file you downloaded in step 3. This will set environment variables that the Openstack cli will use to connect to the OVH public cloud. When you source the openrc.sh file you will be prompted for the password of the Openstack user listed in this file.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ source ~/Downloads/openrc.sh
Please enter your OpenStack Password:
MacBook-Pro:~ standorsett$</code></pre></figure>

<p>If you take a look at your exported environmental variables after sourcing the openrc.sh file, you will see the values from the opensh.rc file set along with your password.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ export | grep OS_
declare -x OS_AUTH_URL=&quot;https://auth.cloud.ovh.us/v3/&quot;
declare -x OS_IDENTITY_API_VERSION=&quot;3&quot;
declare -x OS_PASSWORD=&quot;*******************************&quot;
declare -x OS_PROJECT_DOMAIN_NAME=&quot;Default&quot;
declare -x OS_REGION_NAME=&quot;US-EAST-VA-1&quot;
declare -x OS_TENANT_ID=&quot;2897923a654b40d0b8b36a502bda4a8f&quot;
declare -x OS_TENANT_NAME=&quot;3543682553721111&quot;
declare -x OS_USERNAME=&quot;5r7jJyuwwwsv&quot;
declare -x OS_USER_DOMAIN_NAME=&quot;Default&quot;
MacBook-Pro:~ standorsett$</code></pre></figure>

<h2>8. Using the Openstack cli to create an Openstack server</h2>

<p>Now that you have sourced the openrc.sh file you can create an Openstack server using the Openstack cli.</p>

<p>The four pieces of information you will need to create a new server are:</p>

<ul>
<li>The ssh key pair name that will be allowed to connect.</li>
<li>The operating system (image) you want to use.</li>
<li>The size of the server (flavor) you want to use.</li>
<li>The security group you want to have applied to the server.</li>
</ul>

<p>First list the ssh key pairs so you can see the key pair you created in step 5 by running <code>openstack keypair list</code>. You will need the name of this keypair shortly.</p>

<p><img src="/assets/08102018-16-openstack-cli-keypair-list.png" alt="screenshot"></p>

<p>Next list the available operating system images by running <code>openstack image list</code>. You will need the ID of the image you want to use</p>

<p>I noted <code>e0a89ff2-e98f-4a34-afae-68f9f6c9b5ad</code> for the ID of the Centos 7 image I wanted to use in my test.</p>

<p><img src="/assets/08102018-17-openstack-cli-image-list.png" alt="screenshot"></p>

<p>Next list the available server sizes or flavors by running <code>openstack flavor list</code>. You will need the ID of the flavor of the server you want to create. I wanted to use a <code>s1-2</code> flavor image since it was the smallest sandbox server with the lowest hourly rate, so I noted it&#39;s ID was <code>a64381e7-c4e7-4b01-9fbe-da405c544d2e</code></p>

<p><img src="/assets/08102018-18-openstack-cli-flavor-list.png" alt="screenshot"></p>

<p>Finally list the security groups by running <code>openstack security group list</code>. The default security group which allows all inbound and outbound traffic is named <code>default</code>. I decided to use this default security group for my test rather than create a new one that was more restrictive.</p>

<p><img src="/assets/08102018-19-openstack-cli-security-group-list.png" alt="screenshot">
The default security group is named <code>default</code> so you will need to specify it when creating a server..</p>

<p>Now knowing the flavor id, image id, keypair name and security group name you are ready to create a new openstack server using a command like the following</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">openstack server create --flavor a64381e7-c4e7-4b01-9fbe-da405c544d2e --image e0a89ff2-e98f-4a34-afae-68f9f6c9b5ad --key-name ovhus_public_cloud --security-group default openstack_cli_test
</code></pre></figure>
<p>Below is a screenshot of me running that command.</p>

<p><img src="/assets/08102018-20-openstack-cli-server-create.png" alt="screenshot"></p>

<p>After the Openstack server has been created you can run <code>openstack server list</code> to show the details of the server you just created. The networks field will show the IP address of the server.</p>

<p><img src="/assets/08102018-21-openstack-cli-server-list.png" alt="screenshot"></p>

<p>Now that you know the IP address of the server you just created, You can test connecting to this server using the ssh key you created in the previous blog post.</p>

<p><img src="/assets/08102018-22-openstack-cli-server-ssh.png" alt="screenshot"></p>

<h2>9. Validating the Openstack server in ovhcloud.com UI</h2>

<p>You can check the ovhcloud.com UI to confirm the server has been created and the IP address is the same as what <code>openstack server list</code> displayed.</p>

<p><img src="/assets/08102018-23-ovhcloud-ui-server-created.png" alt="screenshot"></p>

<h2>10. Deleting the Openstack server using the Openstack cli.</h2>

<p>Once you are finished with your openstack server, you should delete the server to prevent being charged for it&#39;s usage. Run the following command in the Openstack cli to delete the server.</p>

<p><img src="/assets/08102018-24-openstack-cli-server-delete.png" alt="screenshot"></p>

<p>Running <code>openstack server list</code> will show that the server has been sucessfully deleted. </p>

<p><img src="/assets/08102018-25-openstack-cli-server-list.png" alt="screenshot"></p>

<p>You can also check the ovhcloud.com UI to confirm the server has been deleted.</p>

<p><img src="/assets/08102018-26-ovhcloud-ui-server-deleted.png" alt="screenshot"></p>

<hr>

<h3>That all for this post covering how to use the Openstack cli utility to create servers on the OVH public cloud.</h3>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/08/08/creating-an-openstack-server-on-ovh-public-cloud/">
        Manually creating an openstack server on OVH public cloud
      </a>
    </h1>

    <span class="post-date">08 Aug 2018</span>

    <p>This is the first in a series of posts that will walk you through using the openstack-based OVH public cloud. In this post you will get introduced to using the ovhcloud.com UI to create an Openstack server.</p>

<p>I will attempt in this post to present the options that are available to OVH public cloud customers along side the choices I made that were specific to my server.</p>

<p>Let&#39;s get started...</p>

<hr>

<h2>1. Create an account at <a href="https://ovhcloud.com/auth/">ovhcloud.com</a>.</h2>

<p>The first thing you will need to do before you can create OVH public cloud servers is setup an account by going to <a href="https://ovhcloud.com/auth/">https://ovhcloud.com/auth/</a> and clicking the &#39;Create an account&#39; button. </p>

<p><img src="/assets/08082018-01-create-an-account.png" alt="screenshot"></p>

<p>After providing my email address, specifying a complex password and adding my billing address I received an email within minutes that my account had been activated.</p>

<h2>2. Setup two-factor authentication.</h2>

<p>The second thing you should do after creating an account is setup two-factor authentication. Enabling two-factor authentication will require that you provide a code (token) from your two-factor authentication application on your phone or physical device, along with your username and password when you log into ovhcloud.com. I would highly recommend setting up two-factor authentication to help prevent unauthorized access to your OVH account.</p>

<p>I found the option to enable two-factor authentication by going to My Account | Security | Two-factor authentication | activate double authentication</p>

<p><img src="/assets/08082018-02-activate-two-factor-auth.png" alt="screenshot"></p>

<p>OVH supports mobile applications and physical devices for two-factor authentication. I selected mobile application since I would be using Google Authenticator.</p>

<p><img src="/assets/08082018-04-activate-two-factor-auth.png" alt="screenshot"></p>

<p>Next I scanned the QR code on my phone, provided a code (token) generated by the Google Authenticator app and gave it a friendly name.</p>

<p><img src="/assets/08082018-05-activate-two-factor-auth.png" alt="screenshot"></p>

<p>After clicking next you will be given emergency codes that can be used if you lose your mobile app or physical two-factor device. Copy these emergency codes and store them in a safe place since they can never be retrieved again. After clicking next the two-factor authentication option will show as being enabled.</p>

<p><img src="/assets/08082018-06-activate-two-factor-auth.png" alt="screenshot"></p>

<h2>3. Adding a payment method.</h2>

<p>You will now need to add a payment method, since it will be used to purchase cloud credits in the next step. I added a payment method by clicking my username at the upper right, clicking &#39;My payment methods&#39; and finally clicking the &#39;Add a payment method&#39; button. Provide your card number, experation date and security code and click the &#39;Add&#39; button.</p>

<p>Once your payment method shows a &quot;Confirmed&quot; status you are ready to proceed to the next step.</p>

<p><img src="/assets/08082018-07-add-payment-method.png" alt="screenshot"></p>

<h2>4. Creating a public cloud project.</h2>

<p>The next step you need to do is create a cloud project. To do this I went to order dropdown and clicked &#39;Cloud project&#39;.</p>

<p><img src="/assets/08082018-08-create-cloud-project.png" alt="screenshot"></p>

<p>Name your project and click &#39;launch your cloud project&#39;.</p>

<p><img src="/assets/08082018-09-create-cloud-project.png" alt="screenshot"></p>

<p>On the next screen you will be purchasing credits that your running servers will consume.</p>

<p><img src="/assets/08082018-10-create-cloud-project.png" alt="screenshot"></p>

<p>Accept the terms and conditions by clicking the check box. Your cloud project will be ordered and payment method charged once you click the &#39;Validate and pay&#39; button. </p>

<p><img src="/assets/08082018-11-create-cloud-project.png" alt="screenshot"></p>

<p>I received an email from OVH within 5 minutes of ordering to tell me that my cloud project had been created.</p>

<h2>5. Creating a new ssh key for OVH public cloud to use.</h2>

<p>You will need to generate a ssh key to connect to the OVH openstack servers. On my mac laptop I ran the following command to generate a new ssh key for this purpose.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ssh-keygen -b 4096 -t rsa -C &quot;stan.dorsett+ovhus_public_cloud@gmail.com&quot; -f ~/.ssh/id_rsa-ovhus_public_cloud</code></pre></figure>

<ul>
<li>The <code>-b</code> option will specify the number of bits in the ssh key.</li>
<li>The <code>-t</code> option with specify the type of ssh key generated.</li>
<li>The <code>-C</code> option will add a comment to the end of the public key file.</li>
<li>The <code>-f</code> option will specify the file that the private key will be saved to. </li>
</ul>

<p>When running the command you will also get asked you if you want to add a passphrase that will need to be provided when you use the ssh key. I didn&#39;t choose to set a passphrase, but you can choose to if you feel the need.</p>

<p>Here is the output from my running of this command.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ ssh-keygen -b 4096 -t rsa -C &quot;stan.dorsett+ovhus_public_cloud@gmail.com&quot; -f ~/.ssh/id_rsa-ovhus_public_cloud
Generating public/private rsa key pair.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /Users/standorsett/.ssh/id_rsa-ovhus_public_cloud.
Your public key has been saved in /Users/standorsett/.ssh/id_rsa-ovhus_public_cloud.pub.
The key fingerprint is:
SHA256:7kSErA6S8zCIq0H/2hmcxE4+JUsW6ZmoDPIE/ULM8I4 stan.dorsett+ovhus_public_cloud@gmail.com
The key&#39;s randomart image is:
+---[RSA 4096]----+
|.                |
| *   ...         |
|. *  oo .        |
|o* .+.+.         |
|E.=.o@ .S        |
|=Xo+O =o         |
|ooo..O  o        |
|..  o +o         |
|.  ..+  .        |
+----[SHA256]-----+
MacBook-Pro:~ standorsett$</code></pre></figure>

<p>Output the public key so you can use it in the next step.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ cat /Users/standorsett/.ssh/id_rsa-ovhus_public_cloud.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDJ8LcFN8MRO/uwgVcdDg0grv
...lots of more characters here...
l0nXM7jjnjD9L3UMFw== stan.dorsett+ovhus_public_cloud@gmail.com
MacBook-Pro:~ standorsett$</code></pre></figure>

<h2>6. Add the ssh pub key to the OVH public cloud.</h2>

<p>You next need to add the public key generate in the previous step to OVH public cloud so it can be used to connect to servers you create.</p>

<p>Go to the project you created in the previous step. You can find this by clicking Cloud | Servers | [your project name].</p>

<p><img src="/assets/08082018-12-view-cloud-project.png" alt="screenshot"></p>

<p>Click the &#39;SSh keys&#39; tab to view or create new ssh keys.</p>

<p><img src="/assets/08082018-13-add-ssh-key.png" alt="screenshot"></p>

<p>Click &#39;Add a new key&#39; to add the public key generated in the previous step.</p>

<p><img src="/assets/08082018-14-add-ssh-key.png" alt="screenshot"></p>

<p>Paste the output from the public key file, provide a friendly name for the ssh key and click &quot;Add this key.&#39;</p>

<p><img src="/assets/08082018-15-add-ssh-key.png" alt="screenshot"></p>

<h2>7. Create a new openstack server.</h2>

<p>Under your cloud project and click the Infrastructure tab. From the Actions dropdown click &#39;Add a server.&#39;</p>

<p><img src="/assets/08082018-16-add-a-server.png" alt="screenshot"></p>

<p>Choose the OS (image) that you want to have deployed.</p>

<p><img src="/assets/08082018-17-pick-an-os-image.png" alt="screenshot"></p>

<p>Select the server type (flavor) of the server you want to create. The server type will specify the number of vcpu, memory, disk size and price per hour of the openstack server that will be created:</p>

<p><img src="/assets/08082018-18-select-instance-type.png" alt="screenshot"></p>

<p>Select the ssh key you created in the previous step. Click the &#39;Launch now&#39; button to create the server.</p>

<p><img src="/assets/08082018-19-launch-instance.png" alt="screenshot"></p>

<p>Once the server is created a &#39;Login information&#39; window will be displayed with the ssh username and ip address you will need to connect to the server.</p>

<p><img src="/assets/08082018-20-login-info.png" alt="screenshot"></p>

<h2>8. SSH to the new openstack server,</h2>

<p>You can now use the login infomation provided in the last step along with the private ssh key you generated to connect to your new server. I used the following commands to ssh from my Mac laptop to connect.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ssh -i /Users/standorsett/.ssh/id_rsa-ovhus_public_cloud centos@147.135.76.67</code></pre></figure>

<ul>
<li>The <code>-i</code> option is used to specify the ssh private key you generated earlier.</li>
</ul>

<p>Here is the output from my running of this command.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">MacBook-Pro:~ standorsett$ ssh -i /Users/standorsett/.ssh/id_rsa-ovhus_public_cloud centos@147.135.76.67
The authenticity of host &#39;147.135.76.67 (147.135.76.67)&#39; can&#39;t be established.
ECDSA key fingerprint is SHA256:aVSsv0mHKgIizglcvouJkvtBBOiZfNcQTpIc5oxhNO4.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;147.135.76.67&#39; (ECDSA) to the list of known hosts.
[centos@server-1 ~]$</code></pre></figure>

<p>You can now run what commands you would like on your new openstack server, like checking the IP address of the server you created.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">[centos@server-1 ~]$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether fa:16:3e:42:97:c4 brd ff:ff:ff:ff:ff:ff
    inet 147.135.76.67/32 brd 147.135.76.67 scope global dynamic eth0
       valid_lft 86350sec preferred_lft 86350sec
    inet6 fe80::f816:3eff:fe42:97c4/64 scope link
       valid_lft forever preferred_lft forever
[centos@server-1 ~]$</code></pre></figure>

<h2>9. Destroy the openstack server.</h2>

<p>Once you are finished with your openstack server, you should delete the server in order to stop being charged for it&#39;s usage. Click the drop down on the server and select &#39;delete&#39; to delete the server.</p>

<p><img src="/assets/08082018-21-instance-options.png" alt="screenshot"></p>

<p>Click &#39;Confirm&#39; to confirm that you want to delete the server. This is your last chance to reconsider if you really want to delete it.</p>

<p><img src="/assets/08082018-22-confirm-delete.png" alt="screenshot"></p>

<p>Your cloud project will now be back to not showing any servers.</p>

<p><img src="/assets/08082018-23-empty-cloud-project.png" alt="screenshot"></p>

<hr>

<h3>That all for this initial post covering how to sign up and get started using the OVH public cloud.</h3>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/08/06/exploring-the-ovhpublic-cloud/">
        Exploring the OVH public cloud and opensource tools that can use it.
      </a>
    </h1>

    <span class="post-date">06 Aug 2018</span>

    <p>This post is the beginning of a series of posts that will explain how to use the openstack-based OVH public cloud UI and opensource tools that you can use to automate and manage your openstack infrastructure. </p>

<p>Over the last few years, I have worked primarily with VMware products and have not taken the time to learn with openstack. Now that the OVH public cloud has launched in the United States, and I work for OVH US, I figured it was time to start learning how customers could put this offering to use.</p>

<p>The posts in this series of blog that have been released are:</p>

<ul>
<li><a href="http://192.168.1.190:4000/2018/08/08/creating-an-openstack-server-on-ovh-public-cloud/">Manually creating an openstack server on OVH public cloud</a></li>
<li><a href="http://192.168.1.190:4000/2018/08/10/using-the-openstack-cli-to-create-a-server-on-ovh-public-cloud/">Using the Openstack cli to create a server on OVH public cloud</a></li>
<li><a href="http://192.168.1.190:4000/2018/08/14/using-rclone-to-connect-to-ovh-public-cloud-swift-storage/">Using rclone to manage OVH Public Cloud swift storage</a></li>
</ul>

<hr>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/28/scripted-packer-build-and-export/">
        Scripted Packer build, ovftool export and Vagrant .box file creation
      </a>
    </h1>

    <span class="post-date">28 Dec 2015</span>

    <p>This is the seventh in a series of posts on <a href="https://sdorsett.github.io/2015/12/22/pipeline-for-creating-packer-box-files/">using a Packer pipeline to generate Vagrant .box files</a>.</p>

<p>In the last post we covered <a href="https://sdorsett.github.io/2015/12/27/using-ovftool-to-export-packer-generated-virtual-machines/">using ovftool to convert Packer generated virtual machines into Vagrant .box files</a>. I promised to show you a better way of exporting and creating the Vagrant .box files, so in this post we will be combining the following items in one script:</p>

<ul>
<li>Kicking off the Packer build of a specific template</li>
<li>Exporting the Packer generated virtual machine</li>
<li>Creating the necessary metadata.json &amp; Vagrantfile files</li>
<li>Compressing the files into a TAR file with the .box extension</li>
<li>Copying the Vagrant .box files to /vat/www/html/box-files/ so they can accessed by HTTP</li>
</ul>

<p>Let&#39;s get started...</p>

<h2>1. Start off by connecting by SSH to CentOS virtual machine we have been using in previous posts.</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sdorsett-mbp:~ sdorsett$ ssh root@192.168.1.52
root@192.168.1.52&#39;s password:
Last login: Sat Dec 26 22:04:20 2015 from 192.168.1.163
[root@packer-centos ~]#</code></pre></figure>

<h2>2. Create a new directory, in the packer-templates directory, for storing build scripts.</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">[root@packer-centos ~]# mkdir ~/packer-templates/build-scripts
[root@packer-centos ~]# cd packer-templates/build-scripts/
[root@packer-centos build-scripts]#</code></pre></figure>

<h2>3. Next we will create a generic script for performing a Packer build of a template.</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">[root@packer-centos build-scripts]# cat generic-packer-build-script.sh
#!/bin/bash

source /root/.bashrc

echo &quot;starting packer build of $PACKER_VM_NAME&quot;
packer build -var-file=packer-remote-info.json /root/packer-templates/templates/$PACKER_VM_NAME.json

echo &quot;registering ${PACKER_VM_NAME} virtual machine on ${PACKER_REMOTE_HOST}&quot;
/usr/bin/sshpass -p ${PACKER_REMOTE_PASSWORD} ssh root@${PACKER_REMOTE_HOST} &quot;vim-cmd solo/registervm /vmfs/volumes/${PACKER_REMOTE_DATASTORE}/output-${PACKER_VM_NAME}/*.vmx&quot;

mkdir -p /root/box_files/ovf/empty_dir/
mkdir -p /root/box_files/vmx/empty_dir/

rm -rf /root/box_files/ovf/${PACKER_VM_NAME}
rm -rf /root/box_files/vmx/${PACKER_VM_NAME}

echo &quot;output of /vmfs/volumes/${PACKER_REMOTE_DATASTORE}/output-${PACKER_VM_NAME}/*.vmxf:&quot;
/usr/bin/sshpass -p ${PACKER_REMOTE_PASSWORD} ssh root@${PACKER_REMOTE_HOST} &quot;cat /vmfs/volumes/${PACKER_REMOTE_DATASTORE}/output-${PACKER_VM_NAME}/*.vmxf&quot;

ovftool vi://root:${PACKER_REMOTE_PASSWORD}@${PACKER_REMOTE_HOST}/${PACKER_VM_NAME} /root/box_files/ovf/
ovftool -tt=vmx vi://root:${PACKER_REMOTE_PASSWORD}@${PACKER_REMOTE_HOST}/${PACKER_VM_NAME} /root/box_files/vmx/

echo &quot;creating metadata.json and Vagrantfile files in ovf virtual machine directory&quot;
echo &#39;{&quot;provider&quot;:&quot;vmware_ovf&quot;}&#39; &gt;&gt; /root/box_files/ovf/${PACKER_VM_NAME}/metadata.json
touch /root/box_files/ovf/${PACKER_VM_NAME}/Vagrantfile
cd /root/box_files/ovf/empty_dir/
cd /root/box_files/ovf/${PACKER_VM_NAME}/

echo &quot;compressing ovf virtual machine files to /var/www/html/box-files/${PACKER_VM_NAME}-vmware_ovf-1.0.box&quot;
tar cvzf /var/www/html/box-files/$PACKER_VM_NAME-vmware_ovf-1.0.box ./*

echo &quot;creating metadata.json and Vagrantfile files in vmx virtual machine directory&quot;
echo &#39;{&quot;provider&quot;:&quot;vmware_desktop&quot;}&#39; &gt;&gt; /root/box_files/vmx/${PACKER_VM_NAME}/metadata.json
touch /root/box_files/vmx/${PACKER_VM_NAME}/Vagrantfile
cd /root/box_files/vmx/empty_dir/
cd /root/box_files/vmx/${PACKER_VM_NAME}/

echo &quot;compressing vmx virtual machine files to /var/www/html/box-files/${PACKER_VM_NAME}-vmware_desktop-1.0.box&quot;
tar cvzf /var/www/html/box-files/$PACKER_VM_NAME-vmware_desktop-1.0.box ./*

echo &quot;cleaning up /root/box_files directories&quot;
rm -rf /root/box_files/ovf/$PACKER_VM_NAME
rm -rf /root/box_files/vmx/$PACKER_VM_NAME

echo &quot;deleting $PACKER_VM_NAME from $PACKER_REMOTE_HOST&quot;
/usr/bin/sshpass -p ${PACKER_REMOTE_PASSWORD} ssh root@${PACKER_REMOTE_HOST}  &quot;vim-cmd vmsvc/getallvms | grep ${PACKER_VM_NAME} | cut -d &#39; &#39; -f 1 | xargs vim-cmd vmsvc/destroy&quot;

echo &quot;packer build of $PACKER_VM_NAME has been  completed&quot;

[root@packer-centos build-scripts]#</code></pre></figure>

<p>If you look over this script you will notice it covers all of the tasks we performed manually in the last two posts. You might all notice the following environmental variables listed:</p>

<ul>
<li>PACKER_REMOTE_HOST</li>
<li>PACKER_REMOTE_USERNAME</li>
<li>PACKER_REMOTE_PASSWORD</li>
<li>PACKER_REMOTE_DATASTORE</li>
<li>PACKER_VM_NAME</li>
</ul>

<p>We are again using the idea of &quot;separating data from code&quot; to keep environment specific information out of the scripts. This will help in keeping sensitive information from being store with our scripts in a code repository.</p>

<h2>4. We now need to added the above listed PACKER_REMOTE environmental variables into the .bashrc file, so the script will know how to connect to vCenter</h2>

<p>Add the following lines to the bottom of /root/.bashrc. Make sure to update any of them that do you match your environment:</p>

<pre>
PACKER_REMOTE_HOST=192.168.1.51
PACKER_REMOTE_USERNAME=root
PACKER_REMOTE_PASSWORD=password
PACKER_REMOTE_DATASTORE=datastore1
</pre>

<p>After updating the ~/.bashrc file, reread the file by running the following command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">[root@packer-centos build-scripts]# source ~/.bashrc
[root@packer-centos build-scripts]#</code></pre></figure>

<p>You can also validate the environmental variables exist by using the echo commmand:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">[root@packer-centos build-scripts]# echo $PACKER_REMOTE_HOST
192.168.1.51
[root@packer-centos build-scripts]#</code></pre></figure>

<h2>5. We need to delete the existing Packer generated virtual machines from the ESXi virtual machine embedded host client, since the Packer build will halt if the virtual machine it is trying to build already exists:</h2>

<p><img src="/assets/01-delete-virtual-machine.png" alt="screenshot">  </p>

<h2>6. With the generic Packer build script and environmental variables in place we can test our script out. First off we need to ensure the execution bit is set on our generic Packer build script:</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">[root@packer-centos build-scripts]# cd ~/packer-templates/
[root@packer-centos packer-templates]# chmod +x build-scripts/generic-packer-build-script.sh
[root@packer-centos packer-templates]# ls -la build-scripts/generic-packer-build-script.sh
-rwxr-xr-x 1 root root 2091 Dec 26 22:27 build-scripts/generic-packer-build-script.sh
[root@packer-centos packer-templates]#</code></pre></figure>

<p>Now that we have set the script as executable, we can use it to build to centos67 template by passing in the PACKER<em>VM</em>NAME environmental variable like the following:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">[root@packer-centos packer-templates]# PACKER_VM_NAME=centos67 build-scripts/generic-packer-build-script.sh
starting packer build of centos67
centos67 output will be in this color.

==&gt; centos67: Downloading or copying ISO
    centos67: Downloading or copying: file:///root/packer-templates/iso/CentOS-6.7-x86_64-minimal.iso
==&gt; centos67: Uploading ISO to remote machine...
==&gt; centos67: Creating virtual machine disk
==&gt; centos67: Building and writing VMX file
==&gt; centos67: Starting HTTP server on port 8001
==&gt; centos67: Registering remote VM...
==&gt; centos67: Starting virtual machine...
==&gt; centos67: Waiting 5s for boot...
==&gt; centos67: Connecting to VM via VNC
==&gt; centos67: Typing the boot command over VNC...
==&gt; centos67: Waiting for SSH to become available...
...</code></pre></figure>

<p>Checking the embedded host client we can see that the CentOS 6.7 operating system is being installed.</p>

<p><img src="/assets/02-centos67-os-install.png" alt="screenshot"></p>

<p>Once the Packer build completes you will see the following output:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">centos67: ==&gt; Zero out the free space to save space in the final image
centos67: dd: writing `/EMPTY&#39;: No space left on device
centos67: 12950+0 records in
centos67: 12949+0 records out
centos67: 13578776576 bytes (14 GB) copied, 462.514 s, 29.4 MB/s
==&gt; centos67: Gracefully halting virtual machine...
centos67: Waiting for VMware to clean up after itself...
==&gt; centos67: Deleting unnecessary VMware files...
centos67: Deleting: /vmfs/volumes/datastore1/output-centos67/vmware.log
==&gt; centos67: Cleaning VMX prior to finishing up...
centos67: Unmounting floppy from VMX...
centos67: Detaching ISO from CD-ROM device...
centos67: Disabling VNC server...
==&gt; centos67: Compacting the disk image
==&gt; centos67: Unregistering virtual machine...
Build &#39;centos67&#39; finished.

==&gt; Builds finished. The artifacts of successful builds are:
--&gt; centos67: VM files in directory: /vmfs/volumes/datastore1/output-centos67</code></pre></figure>

<p>At this point the script will re-register the vm Packer built and output the .vmxf file of the virtual machine. This is use for ensuring vmtools was properly installed, since this file contains the vmtool components and their versions that were successfully installed:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">registering centos67 virtual machine on 192.168.1.51
18
output of /vmfs/volumes/datastore1/output-centos67/*.vmxf:
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;Foundry&gt;&lt;VM/&gt;&lt;tools-install-info&gt;&lt;installError&gt;0&lt;/installError&gt;&lt;updateCounter&gt;1&lt;/updateCounter&gt;&lt;/tools-install-info&gt;&lt;tools-manifest&gt;&lt;monolithic version=&quot;9.9.4&quot;/&gt;&lt;svga33 version=&quot;10.3.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga4 version=&quot;10.4.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse42 version=&quot;1.0.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga42 version=&quot;10.10.2.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse43 version=&quot;12.6.4.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga43 version=&quot;10.16.7.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse43_64 version=&quot;12.6.4.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga43_64 version=&quot;10.16.7.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse67 version=&quot;12.6.4.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga67 version=&quot;10.16.7.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse67_64 version=&quot;12.6.4.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga67_64 version=&quot;10.16.7.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse68 version=&quot;12.6.4.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga68 version=&quot;10.16.7.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse68_64 version=&quot;12.6.4.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga68_64 version=&quot;10.16.7.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse70 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga70 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse70_64 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga70_64 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse71 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga71 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse71_64 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga71_64 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse73 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga73 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse73_64 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga73_64 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse73_99 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga73_99 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse73_99_64 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga73_99_64 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse74 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga74 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse74_64 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga74_64 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse75 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga75 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse75_64 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga75_64 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse76 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga76 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmmouse76_64 version=&quot;12.7.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;svga76_64 version=&quot;11.0.99.4&quot; installed=&quot;FALSE&quot;/&gt;&lt;checkvm version=&quot;9.9.4.51858&quot; installed=&quot;TRUE&quot;/&gt;&lt;vmtoolsd version=&quot;9.9.4.51858&quot; installed=&quot;TRUE&quot;/&gt;&lt;upgrader version=&quot;9.9.4.51858&quot; installed=&quot;FALSE&quot;/&gt;&lt;hgfsclient version=&quot;9.9.4.51858&quot; installed=&quot;TRUE&quot;/&gt;&lt;hgfsmounter version=&quot;9.9.4.51858&quot; installed=&quot;TRUE&quot;/&gt;&lt;vmguestlib version=&quot;9.9.4.51858&quot; installed=&quot;TRUE&quot;/&gt;&lt;vmguestlibjava version=&quot;9.9.4.51858&quot; installed=&quot;TRUE&quot;/&gt;&lt;toolbox-cmd version=&quot;9.9.4.51858&quot; installed=&quot;TRUE&quot;/&gt;&lt;vmci version=&quot;9.6.2.0&quot; installed=&quot;TRUE&quot;/&gt;&lt;vmhgfs version=&quot;1.4.20.1&quot; installed=&quot;TRUE&quot;/&gt;&lt;vmmemctl version=&quot;1.2.1.2&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmsync version=&quot;1.1.0.1&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmxnet version=&quot;2.1.0.0&quot; installed=&quot;TRUE&quot;/&gt;&lt;vmxnet3 version=&quot;1.3.0.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vmblock version=&quot;1.1.2.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;vsock version=&quot;9.6.1.0&quot; installed=&quot;TRUE&quot;/&gt;&lt;pvscsi version=&quot;1.2.3.0&quot; installed=&quot;FALSE&quot;/&gt;&lt;/tools-manifest&gt;&lt;/Foundry&gt;</code></pre></figure>

<p>The next stage of the build script will run the ovftool commands to export .vmx and .ovf format virtual machines from ESXi.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Opening VI source: vi://root@192.168.1.51:443/centos67
Opening OVF target: /root/box_files/ovf/
Writing OVF package: /root/box_files/ovf/centos67/centos67.ovf
Transfer Completed
Completed successfully
Opening VI source: vi://root@192.168.1.51:443/centos67
Opening VMX target: /root/box_files/vmx/
Writing VMX file: /root/box_files/vmx/centos67/centos67.vmx
Transfer Completed
Completed successfully</code></pre></figure>

<p>The next stage of the build script will create the metadata.json and Vagrantfiles needed for the Vagrant .box files. It will then TAR up all the virtual machine files contained in the ovf &amp; vmx folders. This stage will also save the TAR files to /var/www/html/box-files/ so that they will be available over http.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">creating metadata.json and Vagrantfile files in ovf virtual machine directory
compressing ovf virtual machine files to /var/www/html/box-files/centos67-vmware_ovf-1.0.box
./centos67-disk1.vmdk
./centos67.mf
./centos67.ovf
./metadata.json
./Vagrantfile
creating metadata.json and Vagrantfile files in vmx virtual machine directory
compressing vmx virtual machine files to /var/www/html/box-files/centos67-vmware_desktop-1.0.box
./centos67-disk1.vmdk
./centos67.vmx
./metadata.json
./Vagrantfile</code></pre></figure>

<p>The final section of the build script will remove the directories that ovftool generated in /root/box_files (to keep disk space usage to a minimum) and delete the Packer virtual machine from ESXi.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">cleaning up /root/box_files directories
deleting centos67 from 192.168.1.51
packer build of centos67 has been  completed
[root@packer-centos packer-templates]#</code></pre></figure>

<h2>6. We can now list the files in /var/www/html/box-files and see the two .box files generated by the script.</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">[root@packer-centos packer-templates]# ls -lah /var/www/html/box-files/
total 654M
drwxr-xr-x 2 root root 4.0K Dec 28 15:44 .
drwxr-xr-x 3 root root 4.0K Dec 23 18:09 ..
-rw-r--r-- 1 root root 319M Dec 28 15:46 centos67-vmware_desktop-1.0.box
-rw-r--r-- 1 root root 336M Dec 28 15:44 centos67-vmware_ovf-1.0.box
[root@packer-centos packer-templates]#</code></pre></figure>

<p>We can also open a browser and see the .box files the script generated.</p>

<p><img src="/assets/01-browse-vagrant-box-files.png" alt="screenshot">  </p>

<h3>If you would like to not have to manually create the build script covered in this post, you can clone down <a href="https://github.com/sdorsett/packer-templates/tree/adding-build-script">this github repository</a> by running the following command:</h3>

<pre>
git clone -b "adding-build-script" https://github.com/sdorsett/packer-templates.git
</pre>  

<p>If you cloned the packer-templates repo in the last post, you can pull down the updates by running the following command:</p>

<pre>
git fetch --all
git pull origin "adding-build-script"
</pre>  

<h3>This brings us to the end of this post. I hope I made good on my promise of showing an automated ways of converting the Packer templates to .box files. In the next post I think we should cover how to test our Vagrant .box files are functional by deploying them using Vagrant.</h3>

<h3>Please provide any feedback or suggestions to my twitter account located on the about page.</h3>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>
